迁移管理
===================================

提供云桌面的迁移和撤离功能


前置条件
-----------------------------------

以下的主机是指计算节点

以下的撤离可视作特殊的迁移, 为减轻用户的学习难度, 我们会在前端将撤离和迁移混为一谈统称为"迁移"


核心数据模型
-----------------------------------

无


页面跳转逻辑
-----------------------------------

a.迁移管理 - 主机信息

1.查看主机的主机名、管理网络IP、可用域、处理器信息、内存占用比、硬盘占用比、运行/总桌面、主机状态、主机详情、主机功能、宕机迁移等信息, 其中,主机详情用于查看主机的访问网络、管理网络、计算服务(nova-compute)的状态; 主机功能分为常规和备用, 常规是指参与OpenStack的调度,备用则不参与调度; 宕机迁移是指再检测到主机发生宕机时是否自动进行撤离

2.同步主机信息: 将OpenStack记录的计算节点数据同步至本地数据库, 包括管理网络IP、逻辑CPU数、总内存、已使用内存、总硬盘、已使用硬盘、总虚拟机数、计算服务state、计算服务status等数据

3.云桌面迁移: 对主机上的云桌面进行迁移或者撤离操作, 这里用户可以选择自定义迁移即选择迁移的目标主机, 一键迁移则是优先将云桌面迁移至可用的备用主机, 备用主机不够则将剩下的云桌面迁移至常规主机; 迁移时优先将云桌面迁往空闲内存较多的主机

URL 列表 ::

    /vmotion/hostinfo                                显示主机信息管理界面
    /vmotion/update_host_service_status              设置主机为常规或备用
    /vmotion/update_auto_evacuation_status           设置主机在宕机时是否自动撤离
    /vmotion/sync_hostinfo                           同步主机信息
    /vmotion/quick_migration                         一键迁移主机
    /vmotion/custom_migrate                          自定义迁移

b.迁移管理 - 主机信息 - 桌面迁移

点击主机信息表格中的主机名就会跳转至该主机的桌面迁移界面, 这里的桌面全部运行于该主机上

1.查看桌面的名称、使用者、配置、所在主机、IP地址、状态等信息

2.对主机上的云桌面进行迁移

3.重置云桌面状态

4.批量迁移云桌面

5.批量重置云桌面状态

URL 列表 ::

    /vmotion/host_desktop_migration/<string:host_name>           显示主机的桌面迁移界面
    /vmotion/migrate_desktop/                                    迁移单个云桌面
    /vmotion/reset_desktop_status                                重置单个云桌面状态
    /vmotion/batch_migrate                                       批量迁移云桌面
    /vmotion/batch_reset_desktop_status                          批量重置云桌面状态

c.迁移管理 - 桌面迁移

这里的桌面迁移界面与上面的桌面迁移界面功能一致,只是显示的是所有的云桌面

URL 列表 ::

    /vmotion/desktop_migration           显示桌面迁移界面
    /vmotion/migrate_desktop_table       用于异步加载桌面列表

d.迁移管理 - 迁移调度

所有的迁移任务都是交由celery完成

1. 显示所有的迁移任务的信息,包括任务的更新时间、状态、当前阶段、重试次数、执行结果等信息

2. 重做、重置、删除任务

3. 批量重置、重置、删除任务

URL 列表 ::

    /vmotion/migrate_task                显示桌面迁移任务界面
    /vmotion/task_table                  用于异步加载桌面迁移任务列表
    /vmotion/delete_task                 用于删除任务
    /vmotion/tasks/<string:action>       用于重置、重做任务

e.迁移管理 - 迁移调度 - 任务详情

点击迁移调度的任务列表中的任务类型就会跳转至该任务的任务详情界面

1. 显示所选任务的各阶段的名称、创建时间、执行结果和context等信息

URL 列表 ::

    /vmotion/tasks/<int:id>              显示任务详情


核心业务逻辑
-----------------------------------

迁移: 由于迁移的任务周期较长, 所以是交由celery来完成

迁移步骤: '迁移', '等待ACTIVE','检测浮动IP'

撤离步骤: '撤离', '等待ACTIVE','解绑浮动IP','绑定浮动IP','检测浮动IP'


已知问题和扩展
----------------------------------

* 迁移和撤离, 在有多个目标主机时, 会优先会选择空闲内存较多的主机, 这个策略在实际场景下可能会有问题, 需要结合
  空闲VCPU进行判断, 但是需要设定一些权重

* 撤离完成浮动IP会改变




