自动撤离
===================================


实现意义
-----------------------------------

在实际场景下, 计算节点会出现宕机或者网络中断的情况, 导致该节点上的云桌面无法继续提供服务;
为应对这种情况, 我们需要及时将该节点上的云桌面撤离至其他可用节点上, 也就是自动撤离.


服务监控
-----------------------------------

要实现自动, 我们就需要能在第一时间检测到计算节点宕机或者无法提供服务, 这就需要借助到监控功
能; 我们通过监控nova-compute服务、访问网络和管理网络的状态来判断计算节点能否提供服务.


概要设计
-----------------------------------

计算服务监控
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

我们采用OpenStack的接口来获取所有节点的计算服务的状态, 每隔指定时间(默认30s)同步一次.

两个网络监控
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

对于访问网络和管理网络的监控, 我们借助 ZooKeeper_ 这个开源工具, 具体做法如下:

.. _ZooKeeper: http://zookeeper.apache.org/

::

    1.在控制节点上部署ZooKeeper服务器, 为避免单点故障, 可以再选取几个计算节点部署ZooKeeper
    服务器以组成集群

    2.在每个计算节点上部署上ZooAgent服务, 这个服务会为宿主节点在ZooKeeper服务器上创建2个临
    时Znode[例如/monitor/ext/ubuntu和/monitor/mgmt/ubuntu, 其中ubuntu是计算节点的主机名], 
    2个Znode分别对应访问网络和管理网络的状态; 当计算节点的访问网络或者管理网络出现问题时, 
    一旦其session过期, 相应的Znode就会被删除掉

    3.在管理系统上运行一个ZooKeeperWatcher, 它会分别监测上述2个Znode的父Znode[/monitor/ext
    和/monitor/mgmt], 当该父Znode的子Znode发生变化时, 我们就知道有计算节点的网络发生变化了

自动化处理
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

每当检测到有计算节点的网络出现问题, 首先会将状态写入数据库, 然后对该计算节点的服务状态、两网状
态进行判定, 如果满足以下条件, 就根据用户的设置选择是否进行自动撤离; 其他条件则发送相应的通知邮件. ::

    +----------+----------+----------+----------+
    | 计算节点 | 计算服务 | 访问网络 | 管理网络 |
    +==========+==========+==========+==========+
    |  ubuntu  |   down   |   down   |   down   |
    +----------+----------+----------+----------+
    注: 当计算节点处于该状态时, 我们大致可以判定其无法提供服务了, 但是无法确定, 譬如ZooAgent
    和nova-compute都挂掉就会导致误判







