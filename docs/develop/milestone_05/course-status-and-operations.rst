课程状态与课程操作
===================================

课程状态用于标识课程所处的状态，课程操作是用户可以对课程进行的各类操作。
用户可用的课程操作会根据课程的状态变化而变化，不同的课程状态下允许用户进行不同的课程操作，同时禁用一些课程操作。课程状态和课程操作分类如下：

课程状态用于标识课程现在所处的状态，如下 ::

    1. 上课中
       课程处于上课的状态，即课程现在有课时，可以使用课程方法 find_current_lesson（） 查询，课程所处的状态不参考课程桌面的数量

    2. 课程已关闭
       课程已经处于关闭状态，即课程现在没有课时，同上，可用方法 find_current_lesson() 查询，课程所处的状态不参考课程桌面的数量

    3. 处理中
       用户点击手动关闭课程操作（调整课程当时课时时间和关闭课程桌面）后，和系统完全关闭课程之间用户的等待时间所处的状态

课程操作包括 ::

    1. 手动启动课程
       当用户（管理员，教师）想马上上课时，用户可以忽略系统事先设定的课程调度，点击手动启动课程，并填写课程的结束时间后，系统会马上启动该课程，并启动课程桌面

    2. 手动关闭课程
       当用户（管理员，教师）想马上上课时，用户可以忽略系统事先设定的课程调度，点击手动关闭课程后，系统会马上关闭该课程，并回收课程桌面

    3. 延时课程
       延时课程时首先延时课时，然后延时课程桌面

    4. 删除课程
       删除课程记录，其中包括删除与课程关联的课时记录


状态和操作的关系
-----------------------------------

不同的状态允许用户进行不同的操作，同时禁用一些操作，具体如下：

上课中状态下的课程操作如下 ::

    1. 延时课程
       课程桌面必须都已经启动完毕后才能进行该操作，原因请查看*核心业务逻辑*

    2. 手动关闭课程

课程已关闭状态下的课程操作如下 ::

    1. 手动启动课程

    2. 删除课程

处理中状态下的课程操作如下 ::

    1. 手动关闭课程


核心数据模型
-----------------------------------

无

页面跳转逻辑
-----------------------------------

无

核心业务逻辑
-----------------------------------

* 延时课程

只有当课程处于上课中，并且课程桌面都已经启动完毕后，才能作课程延时操作
因为桌面没有创建完毕就对课程进行延时操作，延时操作只会对现有的课程桌面进行延时，之后创建的桌面都没有延时，这会造成这批课程桌面的结束时间不一致

* 手动关闭课程

在处理用户关闭课程的指令时，系统后台会遇到两种情况需要处理，
第一种是正常关闭课程，即所有的课程桌面调度任务已经完成（成功或失败均可），这时用户发出课程关闭指令，系统的处理逻辑如下 ::

    1. 关闭课程的当时课时，即把当前课时的结束时间设置为当时

    2. 关闭课程所有桌面，即向 openstack 发出删除虚拟机命令，同时删除系统本地的桌面记录

第二种是课程启动中关闭课程，即课程桌面任务还在执行当中，这时用户发出了关闭课程指令。这种情况下，逻辑上需要先把未完成的桌面任务设置为不可用，阻止任务继续执行，
然后把这些未完成的任务回滚，对于已经完成的任务，则正常处理，即关闭已经创建好的课程桌面即可。具体逻辑步骤如下 ::

    1. 与正常关闭课程的第一个步骤相同

    2. 中断正在执行的桌面任务，设置正在执行的桌面任务为不可用，并回滚已经完成的任务阶段

    3. 与正常关闭课程的第三个步骤相同

由于现阶段任务模型的限制，不支持任务中断和任务回滚。现只实现如下逻辑 ::

    1. 与正常关闭课程的第一个步骤相同

    2. 设置正在运行的桌面任务为完成状态

    3. 与正常关闭课程的第三个步骤相同

    4. 重复1至3的步骤，即需要用户每隔一段时间按下课程关闭按钮，并查看课程桌面数量，直至所有课程桌面被成功关闭


* 手动启动课程

手动启动课程的流程如下：

    1. 用户提供课时的结束日期和结束时间

    2. 系统根据用户提供的数据时间检查即将新建的课时的合法性，合法性通过，则会创建以个与该课程关联的课时，开始时间为当时，结束时间为用户提供的结束日期和时间
      假如不能通过合法性检验，则说明即将新建的课时和已经存在的课时存在时间上的冲突，系统会返回有冲突的课时列表给用户，提示是否删除已存在的冲突课时以
      启动课程

    3. 确定要删除已经存在的冲突课时，以启动课程，则系统启动该课程，否则不启动课程

* 删除课程

删除课程和与课程关联的课时的数据库记录

已知问题和扩展
----------------------------------

无