{% extends 'layout.html' %}

{% block title %}云课室 - 课程详情{% endblock %}

{% block inline_styles %}
    <style type="text/css">
    .schedule_item-hover{
        background-color: #ABCFE7
    }
    .select_item{
        background-color: #2283C5;
    }
    .editable-input{
        padding-left: 12px;
    }
    </style>

{% endblock %}


{% block page_content %}
    <div class="page-header">
        <h1>{{ course.name }}</h1>
    </div>
    <input type="text" hidden="hidden" id="course_id" value="{{ course.id }}"/>
    <div class="col-xs-12">
        <!-- PAGE CONTENT BEGINS -->
        <div class="row">
            <div>
                <div class="tabbable">
                    <ul class="nav nav-tabs" id="myTab">
                        <li class="active">
                            <a data-toggle="tab" href="#class_info">基本信息</a>
                        </li>
                        <li>
                            <a data-toggle="tab" href="#student_list">学生名单</a>
                        </li>
                        <li>
                            <a data-toggle="tab" href="#desktop_list">课程桌面</a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <!-- lessons -->
                        <div id="class_info" class="tab-pane fade in active ui-sortable">
                            <form id="course_form" class="form-horizontal no-padding" role="form" method="post">
                                {{ form.csrf_token }}
                                <div class="row">
                                    <div class="widget-box transparent col-sm-6">
                                        <div class="widget-body" >
                                            <div class="widget-main padding-6 no-padding-left no-padding-right">
                                                <div class="profile-user-info profile-user-info-striped">
                                                    <div class="profile-info-row">
                                                        <div class="profile-info-name" style="width: 150px; text-align: center"> 课程名称 </div>
                                                        <div class="profile-info-value">
                                                            <a class="editable text-editable" id="course_name" name="name"> {{ course.name }} </a>
                                                            <input hidden="hidden" id="form_course_name" name="name" placeholder="课程名称" type="text" value={{form.name.data}} data-rule-required='true' data-msg-required='请输入课程名称' data-rule-maxlength="64" data-msg-maxlength='长度不超过64个字'>
                                                        </div>
                                                    </div>

                                                    <div class="profile-info-row">
                                                        <div class="profile-info-name" style="width: 150px; text-align: center"> 授课老师 </div>
                                                        <div class="profile-info-value">
                                                            <a class="editable list-editable" id="course_owner"> {{ course_owner.fullname }} </a>
                                                            <input class="select2" id="form_course_owner" name="owner_id" hidden="hidden" type="hidden" value={{course.owner.id}}>
                                                        </div>
                                                    </div>

                                                    <div class="profile-info-row">
                                                        <div class="profile-info-name" style="width: 150px; text-align: center"> 开始日期 </div>
                                                        <div class="profile-info-value">
                                                            <a class="editable date-editable" id="course_start_date"> {{ course.start_date }} </a>
                                                            <input id="form_course_start_date" name="start_date" hidden="hidden" type="text" value={{form.start_date.data}} data-date-format="yyyy-mm-dd" data-rule-required='true' data-msg-required='请选择开始时间'>
                                                        </div>
                                                    </div>

                                                    <div class="profile-info-row">
                                                        <div class="profile-info-name" style="width: 150px; text-align: center"> 结束日期 </div>
                                                        <div class="profile-info-value">
                                                            <a class="editable date-editable" id="course_end_date"> {{ course.end_date }} </a>
                                                            <input id="form_course_end_date" name="end_date" hidden="hidden" type="text" value={{form.end_date.data}} data-date-format="yyyy-mm-dd" data-rule-required='true' data-msg-required='请选择结束时间'>
                                                        </div>
                                                    </div>

                                                    <div class="profile-info-row">
                                                        <div class="profile-info-name" style="width: 150px; text-align: center"> 指定教室 </div>
                                                        <div class="profile-info-value">
                                                            <a class="editable list-editable" id="course_places">{% for place in course.places %}{% if loop.last %}{{ place.name }}{% else %}{{ place.name }},{% endif %}{% endfor %}</a>
                                                            <select class="select2" hidden="hidden" data-placeholder="指定课室" id="form_course_places" multiple name="places" style="width:100%">
                                                            {% for choice in form.places.choices %}
                                                                {% if form.places.coerce(choice[0]) not in form.places.data %}
                                                                    <option value={{choice[0]}}>{{choice[1]}}</option>
                                                                {% else %}
                                                                    <option selected value={{choice[0]}}>{{choice[1]}}</option>
                                                                {% endif %}
                                                            {% endfor %}</select>
                                                        </div>
                                                    </div>

                                                    <div class="profile-info-row">
                                                        <div class="profile-info-name" style="width: 150px; text-align: center"> 课程外设策略 </div>
                                                        <div class="profile-info-value">
                                                            <a class="editable list-editable" id="course_policy"> {{ course_policy.name }} </a>
                                                            <select class="select2" hidden="hidden" data-placeholder="课程外设策略" id="form_course_policy" name="policy_id" style="width:100%">
                                                            {% for choice in form.policy_id.choices %}
                                                                {% if form.policy_id.coerce(choice[0]) != form.policy_id.data %}
                                                                    <option value={{choice[0]}}>{{choice[1]}}</option>
                                                                {% else %}
                                                                    <option selected value={{choice[0]}}>{{choice[1]}}</option>
                                                                {% endif %}
                                                            {% endfor %}
                                                            </select>
                                                        </div>
                                                    </div>

                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="widget-box transparent col-sm-6">
                                        <div class="widget-body" >
                                            <div class="widget-main padding-6 no-padding-left no-padding-right">
                                                <div class="profile-user-info profile-user-info-striped ">
                                                    <div class="profile-info-row">
                                                        <div class="profile-info-name" style="width: 150px; text-align: center"> 课程镜像 </div>
                                                        <div class="profile-info-value">
                                                            <a class="editable list-editable" id="course_image"> {{ course_image.name }} </a>
                                                            <select class="select2" hidden="hidden" id="form_course_image" name="image_ref" style="width:100%" data-rule-required='true' data-msg-required='请选择课程镜像'>
                                                            {% for choice in form.image_ref.choices %}
                                                                {% if form.image_ref.coerce(choice[0]) not in form.image_ref.data %}
                                                                    <option value={{choice[0]}}>{{choice[1]}}</option>
                                                                {% else %}
                                                                    <option selected value={{choice[0]}}>{{choice[1]}}</option>
                                                                {% endif %}
                                                            {% endfor %}</select>
                                                        </div>
                                                    </div>

                                                    <div class="profile-info-row">
                                                        <div class="profile-info-name" style="width: 150px; text-align: center"> 配置类型 </div>
                                                        <div class="profile-info-value">
                                                            <a class="editable list-editable" id="course_flavor"> {{ course_flavor_description }}</a>
                                                            <select class="select2" hidden="hidden" id="form_course_flavor" name="flavor_ref" style="width:100%" data-rule-required='true' data-msg-required='请选择配置类型'>
                                                            {% for choice in form.flavor_ref.choices %}
                                                                {% if form.flavor_ref.coerce(choice[0]) not in form.flavor_ref.data %}
                                                                    <option value={{choice[0]}}>{{choice[1]}}</option>
                                                                {% else %}
                                                                    <option selected value={{choice[0]}}>{{choice[1]}}</option>
                                                                {% endif %}
                                                            {% endfor %}</select>
                                                        </div>
                                                    </div>

                                                    <div class="profile-info-row">
                                                        <div class="profile-info-name" style="width: 150px; text-align: center"> 桌面数量 </div>
                                                        <div class="profile-info-value">
                                                            <a class="editable number-editable" id="course_capacity"> {{ course.capacity }} </a>
                                                            <input hidden="hidden" id="form_course_capacity" name="capacity" type="digits" value={{form.capacity.data}} aria-required="true" data-rule-required='true' data-msg-required='请输入桌面数量' data-rule-min="0" data-msg-min='请输入非负整数'>
                                                        </div>
                                                    </div>

                                                    <div class="profile-info-row">
                                                        <div class="profile-info-name" style="width: 150px; text-align: center"> 虚拟内网 </div>
                                                        <div class="profile-info-value">
                                                            <a class="editable list-editable" id="course_network"> {{ course_network }} </a>
                                                            <select class="select2" hidden="hidden" id="form_course_network" name="network_ref" style="width:100%">
                                                            {% for choice in form.network_ref.choices %}
                                                                {% if form.network_ref.coerce(choice[0]) not in form.network_ref.data %}
                                                                    <option value={{choice[0]}}>{{choice[1]}}</option>
                                                                {% else %}
                                                                    <option selected value={{choice[0]}}>{{choice[1]}}</option>
                                                                {% endif %}
                                                            {% endfor %}</select>
                                                        </div>
                                                    </div>

                                                    <div class="profile-info-row">
                                                        <div class="profile-info-name" style="width: 150px; text-align: center"> 客户端连接协议 </div>
                                                        <div class="profile-info-value">
                                                            <a class="editable list-editable" id="course_protocol"> {{ course.protocol }} </a>
                                                            <select class="select2" hidden="hidden" data-placeholder="客户端连接协议" id="form_course_protocol" name="protocol" style="width:100%">
                                                            {% for choice in form.protocol.choices %}
                                                                {% if form.protocol.coerce(choice[0]) != form.protocol.data %}
                                                                    <option value={{choice[0]}}>{{choice[1]}}</option>
                                                                {% else %}
                                                                    <option selected value={{choice[0]}}>{{choice[1]}}</option>
                                                                {% endif %}
                                                            {% endfor %}</select>
                                                        </div>
                                                    </div>

                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>

                            <div class="widget-box" id="show_timetable" >
                                <div class="widget-body">
                                    <div class="widget-toolbox padding-10">
                                        <div class="row">
                                            <div class="col-sm-3"></div>
                                            <div class="col-sm-6" align="center">
                                                <a class="label label-xlg label-success arrowed" id="link_last_week" style="visibility: visible">上一周</a>
                                                <input type="hidden" id="hidden_start_date" value="{{ week_date[0]|date_format('yyyy-MM-dd') }}" />

                                                <span class="week-date-picker"><input style="width:250px; text-align: center" id="week_date_range" name="date-period"  type="text"
                                                       value="{{ week_date[0]|date_format('yyyy年MM月dd日') }}  --  {{ week_date[1]|date_format('yyyy年MM月dd日') }}" readonly/></span>
                                                <a class="label label-xlg label-success arrowed-right" id="link_next_week" style="visibility: visible">下一周</a>
                                            </div>
                                            <div class="col-sm-3">
                                                <div class="widget-toolbar">
                                                    <div class="action-buttons">
                                                        <a id="add_timetable" href="javascript:void(0)" title="添加"><i class="ace-icon fa fa-plus-circle fa-lg fa-fw" aria-hidden="true"></i> </a>
                                                        <a id="edit_timetable" class="blue" href="javascript:void(0)"  title="修改" style="display:inline"><i class="ace-icon fa fa-pencil-square-o fa-lg fa-fw" aria-hidden="true"></i> </a>
                                                        <a id="save_timetable" href="javascript:void(0)" title="保存" style="display:none"><i class="ace-icon fa fa-save fa-lg fa-fw" aria-hidden="true"></i> </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="widget-main no-padding" id="week_timetable">
                                            {% include 'edu/week_timetable.html' %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="student_list" class="tab-pane fade ui-sortable">
                            <div class="widget-box">
                                <div class="widget-body">
                                    <div class="widget-toolbox padding-10">
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <div class="action-buttons">
                                                    <a id="add_students" href="javascript:void(0)" title="添加学生用户"><i class="ace-icon fa fa-plus-circle"></i> 添加学生用户 </a>
                                                    <a id="delete_students" class="red" href="javascript:void(0)" title="删除所选用户"><i class="ace-icon fa fa-trash"></i> 删除所选用户 </a>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div style="text-align: right;">
                                                    <div class="btn-group">
                                                        <button data-toggle="dropdown" class="btn btn-info btn-xs dropdown-toggle" aria-expanded="false">
                                                            导入
                                                            <span class="ace-icon fa fa-caret-down icon-on-right"></span>
                                                        </button>
                                                        <ul class="dropdown-menu dropdown-info dropdown-menu-right">
                                                            <li>
                                                                <a href="javascript:void(0)" id="upload_users_dialog_pop">导入名单</a>
                                                            </li>
                                                            <li>
                                                                <a id="download_template" href="{{ url_for('static', filename='students.xls') }}" download='学生用户导入模板.xls' title="下载模板">下载名单模板</a>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="widget-main no-padding">
                                        <table id="students_table" class="table table-striped table-bordered table-hover">
                                            <thead>
                                            <tr>
                                                <th class="center"><label class="pos-rel"><input type="checkbox" class="ace"><span class="lbl"></span></label></th>
                                                <th>学生编号</th>
                                                <th>学生姓名</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            {% if course %}
                                                {% for student in course.students %}
                                                    <tr>
                                                        <td class="center"><label class="pos-rel"><input type="checkbox" id="student_{{ student.id }}" class="ace">
                                                            <span class="lbl"></span></label></td>
                                                        <td>{{ student.username }}</td>
                                                        <td>{{ student.fullname }}</td>
                                                    </tr>
                                                {% endfor %}
                                            {% endif %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>



                            <!-- desktops -->
                        <div id="desktop_list" class="tab-pane fade ui-sortable">
                            <div class="widget-box">

                                <div class="widget-body">
                                    <div class="widget-toolbox padding-10">
                                        <div class="row">
                                            <div class="col-sm-6">
                                                {% if course.find_current_lesson() %}
                                                    <div class="action-buttons">
                                                        <a href="javascript:void(0)" id="supply_desktop" title="补充桌面">
                                                            <i class="ace-icon fa fa-plus-circle"> </i> 补充桌面
                                                        </a>
                                                    </div>
                                                {% else %}
                                                    <a href="javascript:void(0)" id="not_supply_desktop" title="目前课程未上课，无法补充桌面">
                                                        <i class="ace-icon fa fa-plus-circle"> </i> 补充桌面
                                                    </a>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="widget-main no-padding">
                                        <table id="desktops_table" class="table table-striped table-bordered table-hover">
                                            <thead>
                                            <tr>
                                                <th>桌面名称</th>
                                                <th>电源状态</th>
                                                <th>系统状态</th>
                                                <th>回收时间</th>
                                                <th>使用者</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            {% if course %}
                                                {% for desktop in course.desktops %}
                                                    <tr id="{{ desktop.id }}">
                                                        <td id="desktop_name_{{ desktop.id }}"><a href="{{ url_for('desktop.desktop_console', id=desktop.vm_ref) }}">{{ desktop.name }}</a></td>
                                                        <td id="desktop_vmstate_{{ desktop.id }}">{{ desktop.vm_state }}</td>
                                                        <td id="desktop_osstate_{{ desktop.id }}">{{ desktop.os_state }}</td>
                                                        <td id="desktop_enddatetime_{{ desktop.id }}">{{ desktop.end_datetime }}</td>
                                                        <td id="desktop_owner_{{ desktop.id }}">
                                                            {% if desktop.owner %}
                                                                {{ desktop.owner.username }}
                                                                <span style="float: right">
                                                                    <a href="javascript:void(0)" id="owner-unbunding"  onclick="on_unbunding_click({{ desktop.id }})">解绑</a>
                                                                    {# <a  href="#" title="修改用户"><i class="ace-icon fa fa-pencil-square-o bigger-130"></i></a> #}
                                                                </span>
                                                            {% else %}
                                                                无人占用
                                                                <span style="float: right">
                                                                    <a href="javascript:void(0)" id="owner-binding"  onclick="on_binding_click({{ desktop.id }})">绑定</a>
                                                                </span>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            {% endif %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="add_lessons_modal" class="modal fade">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">添加上课时间</h4>
                </div>
                <div class="modal-body">
                    <form id="lessons_form" action="#" method="post">
                        {{ lesson_form.hidden_tag() }}
                        <div class="row">
                            <div class="col-sm-6">
                                {{ lesson_form.frequency.label }}
                                <br>

                                <div class="btn-group" data-toggle="buttons">
                                    {% for choice in lesson_form.frequency.choices -%}
                                        <label class="btn btn-info {% if loop.first %}active{% endif %}">
                                            <input type="radio" name="frequency" value="{{ choice[0] }}"
                                                   {% if loop.first %}checked="checked"{% endif %}>{{ choice[1] }}
                                        </label>
                                    {%- endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="space-6"></div>
                        <div class="row">
                            <div class="col-sm-6" id="start_date_div">
                                <label>开始日期</label>
                                {{ lesson_form.start_weekday(id='weekly_start_weekday_select', class_="form-control", required=True) }}
                                <div id="start_date_control" class="input-group date_control" style="display: none">
                                    {{ lesson_form.start_date(id='once_start_date_datepicker', class_="form-control date-picker", type='text') }}
                                    <span class="input-group-addon"><i class="fa fa-calendar bigger-110"></i></span>
                                </div>
                            </div>
                            <div class="col-sm-6" id="start_time_div">
                                <label>开始时间</label>

                                <div class="btn-group" data-toggle="buttons">
                                    {% for choice in lesson_form.start_time_type.choices -%}
                                        <label class="btn btn-minier btn-info {% if loop.first %}active{% endif %}">
                                            <input type="radio" name="{{ lesson_form.start_time_type.name }}"
                                                   value="{{ choice[0] }}"
                                                   {% if loop.first %}checked="checked"{% endif %}>{{ choice[1] }}
                                        </label>
                                    {%- endfor %}
                                </div>
                                {{ lesson_form.start_period_id(id='start_period_id_select', class_="form-control", required=True) }}
                                <div id="start_time_control" class="input-group" style="display: none;">
                                    {{ lesson_form.start_time(id='start_time_datetime_control', class_="form-control time-picker", type='text') }}
                                    <span class="input-group-addon"><i class="fa fa-clock-o bigger-110"></i></span>
                                </div>
                            </div>
                        </div>
                        <div class="space-6"></div>
                        <div class="row">
                            <div class="col-sm-6" id="end_date_div">
                                <label>结束日期</label>
                                <select name="end_weekday" class="form-control" data-rule-end_weekday="true"
                                        required>
                                    {% for i in lesson_form.end_weekday.choices -%}
                                        <option value="{{ i[0] }}">{{ i[1] }}</option>
                                    {%- endfor %}
                                </select>

                                <div id="end_date_control" class="input-group date_control" style="display: none">
                                    <input name="end_date" type="text" class="form-control date-picker"
                                           data-rule-end_data="true">
                                    <span class="input-group-addon"><i class="fa fa-calendar bigger-110"></i></span>
                                </div>
                            </div>
                            <div class="col-sm-6" id="end_time_div">
                                <label>结束时间</label>

                                <div class="btn-group" data-toggle="buttons">
                                    {% for choice in lesson_form.end_time_type.choices -%}
                                        <label class="btn btn-minier btn-info {% if loop.first %}active{% endif %}">
                                            <input type="radio" name="{{ lesson_form.end_time_type.name }}"
                                                   value="{{ choice[0] }}"
                                                   {% if loop.first %}checked="checked"{% endif %}>{{ choice[1] }}
                                        </label>
                                    {%- endfor %}
                                </div>
                                <select name="end_period_id" class="form-control" data-rule-end_period required>
                                    {% for i in lesson_form.end_period_id.choices -%}
                                        <option value="{{ i[0] }}">{{ i[1] }}</option>
                                    {%- endfor %}
                                </select>

                                <div id="end_time_control" class="input-group" style="display: none">
                                    <input name="end_time" type="text" class="form-control time-picker"
                                           data-rule-end_time="true">
                                    <span class="input-group-addon"><i class="fa fa-clock-o"></i></span>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button id="comfirm_add_lesson" type="button" class="btn btn-success"> 添加 </button>
                    <button type="button" class="btn btn-default" data-dismiss="modal"> 关闭 </button>
                </div>
            </div>
        </div>
    </div>


    <div id="upload_users_dialog" class="modal">
        <div class="modal-dialog  modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">导入学生名单</h4>
                </div>
                <div class="modal-body">
                    <form id="upload_form" method="POST" enctype="multipart/form-data">
                        {% if upload_student_form %}
                            {{ upload_student_form.csrf_token }}
                        {% endif %}
                        {{ upload_student_form.file(id="studentfile") }}
                        <div>
                            <span id="upload_message" class="hidden red"></span>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button id="upload_file" type="button" class="btn btn-success"> 导入 </button>
                    <button type="button" class="btn btn-default" data-dismiss="modal"> 关闭 </button>
                </div>
            </div>
        </div>
    </div>

    <div id="add_students_dialog" class="modal fade">
        <div class="modal-dialog ">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">添加学生用户</h4>
                </div>
                <div class="modal-body" style="padding-left: 24px;padding-right: 24px">
                    <div class="red alert alert-danger" id="error-info" style="display: none">
                        <button id="error-info-close" type="button" class="close" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <i class="ace-icon fa fa-warning icon-animated-bell bigger-130"></i> 请选择需要添加的学生用户！
                    </div>
                    <form id="students_form" method="POST">
                        {{ student_list_form.csrf_token }}
                        {{ student_list_form.students(id="search_student", type="text", placeholder="输入学生学号或姓名") }}
                     </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal"> 关闭</button>
                    <button id="confirm_add_students" type="button" class="btn btn-danger"> 添加</button>
                </div>
            </div>
        </div>
    </div>

        <!-- supply desktop confirmation dialog -->
    <div id="supply_desktop_confirm_dialog" class="modal fade">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">补充桌面</h4>
                </div>
                <div class="modal-body">
                    <form id="supply_desktop_form">
                        <input class="form-control supply_desktops_number" type="text" id="desktop_count" placeholder="请输入桌面数量(个)" >
                    </form>
                </div>
                <div class="modal-footer">
                    <button id="confirm_supply" type="button" class="btn btn-success"> 确定 </button>
                    <button type="button" class="btn btn-default" data-dismiss="modal"> 关闭 </button>
                </div>
            </div>
        </div>
    </div>

    <div id="delete_student_confirm_dialog" class="modal">
        <div class="modal-dialog  modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">确认删除</h4>
                </div>
                <div class="modal-body">
                    <span class="red"><i class="ace-icon fa fa-warning bigger-130 icon-animated-bell"></i> 确认把所选择的学生从选课名单中移除?</span>
                </div>
                <div class="modal-footer">
                    <button id="confirm_delete_student" type="button" class="btn btn-danger"> 确认</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal"> 关闭</button>
                </div>
            </div>
        </div>
    </div>

    <div id="binding_dialog" class="modal fade">
        <div class="modal-dialog ">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">绑定用户</h4>
                </div>
                <div class="modal-body" style="padding-left: 24px;padding-right: 24px">
                    <div class="red alert alert-danger" id="error-info" style="display: none">
                        <button id="error-info-close" type="button" class="close" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <i class="ace-icon fa fa-warning icon-animated-bell bigger-130"></i> 请选择需要进行绑定的学生用户
                    </div>
                    <span style="padding-left: 20px;padding-right: 15px"><label for="binding_student_select2">请选择学生用户:</label></span>
                    <input class="select2" id="binding_student_select2">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal"> 关闭</button>
                    <button id="confirm_binding" type="button" class="btn btn-danger"> 绑定</button>
                </div>
            </div>
        </div>
    </div>

    <div id="unbunding_dialog" class="modal fade">
        <div class="modal-dialog  modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">解除绑定</h4>
                </div>
                <div class="modal-body">
                    <p class="red"><i class="ace-icon fa fa-warning icon-animated-bell bigger-130"></i> 确定解除所选择的桌面与使用者之间的绑定关系?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal"> 取消</button>
                    <button id="confirm_unbunding" type="button" class="btn btn-danger"> 解除</button>
                </div>
            </div>
        </div>
    </div>


    <div id="get_course_image_list" style="visibility: hidden">
        {% for (k,v) in image_list %}
        <div class="images" id="{{ k }}">{{ v }}</div>
        {% endfor %}
    </div>

    <div id="get_course_flavor_list" style="visibility: hidden">
        {% for (k,v) in flavors_list %}
        <div class="flavors" id="{{ k }}">{{ v }}</div>
        {% endfor %}
    </div>

    <div id="get_course_network_list" style="visibility: hidden">
        {% for (k,v) in network_list %}
        <div class="networks" id="{{ k }}">{{ v }}</div>
        {% endfor %}
    </div>

    <div id="get_course_protocol_list" style="visibility: hidden">
        {% for (k,v) in protocol_list %}
        <div class="protocols" id="{{ k }}">{{ v }}</div>
        {% endfor %}
    </div>

    <div id="get_course_policy_list" style="visibility: hidden">
        {% for (k,v) in policy_list %}
        <div class="policies" id="{{ k }}">{{ v }}</div>
        {% endfor %}
    </div>

    <div id="get_course_place_list" style="visibility: hidden">
        {% for (k,v) in places_list %}
        <div class="places" id="{{ k }}">{{ v }}</div>
        {% endfor %}
    </div>

    <div style="display:none;" id="image-storage">
        {% for image in image_detail_list %}
            <div id="image-storage-{{image.id}}" style="display:none;">
                <span id="image-storage-{{image.id}}-ram">{{image.min_ram}}</span>
                <span id="image-storage-{{image.id}}-disk">{{image.min_disk}}</span>
            </div>
        {% endfor %}
    </div>

{% endblock %}

{% block inline_scripts %}
    {{ super() }}
    <script>
        active_sidebar("#courses");

        var selected_students = [];
        var selected_lessons = [];

        var student_select2 = null;

        var binding_student_select2 = null;

        var courseID = $('#course_id').val();
        var url_binding_template = "{{ url_for('edu.binding_students', id=0) }}";
        var url_binding = url_binding_template.replace('0', courseID);

        var params_lists = [];
        var default_param = {};

        var lessons_lists = {};
        var change_lessons_lists = {};
        change_lessons_lists["add_lessons_lists"] = {};
        change_lessons_lists["delete_lessons_lists"] = {};

        var course_start_date = "{{ course.start_date | date_format }}";
        var course_end_date = "{{ course.end_date | date_format }}";

        function get_all_lessons(week_date){
            lessons_lists[week_date] = {};
            $.each( $(".schedule_item") , function(k, v){
                if ($(this).hasClass("select_item"))
                    lessons_lists[week_date][v.id] = true;
                else
                    lessons_lists[week_date][v.id] = false;
                }
            )
        }

        function get_all_iamge() {
            $.each( $(".images") , function(k, v){
                params_lists["image"].push({id: v.id, text: v.innerHTML});
                }
            )
        }

        function get_all_flavor() {
            $.each( $(".flavors") , function(k, v){
                params_lists["flavor"].push({id: v.id, text: v.innerHTML});
                }
            )
        }

        function get_all_network() {
            $.each( $(".networks") , function(k, v){
                params_lists["network"].push({id: v.id, text: v.innerHTML});
                }
            )
        }

        function get_all_protocol() {
            $.each( $(".protocols") , function(k, v){
                params_lists["protocol"].push({id: v.id, text: v.innerHTML});
                }
            )
        }

        function get_all_policy() {
            $.each( $(".policies") , function(k, v){
                params_lists["policy"].push({id: v.id, text: v.innerHTML});
                }
            )
        }

        function get_all_place() {
            $.each( $(".places") , function(k, v){
                params_lists["place"].push({id: v.id, text: v.innerHTML});
                }
            )
        }

        function init_select_list() {
            params_lists['image'] = [];
            params_lists['flavor'] = [];
            params_lists['network'] = [];
            params_lists['protocol'] = [];
            params_lists['policy'] = [];
            params_lists['place'] = [];
            get_all_iamge();
            get_all_flavor();
            get_all_network();
            get_all_protocol();
            get_all_policy();
            get_all_place();
        }

        function find_id() {
            $.each( $(".images"), function (k, v){
                if (v.innerHTML.replace(/ /g,'') == default_param["image"]) {
                    default_param["image"] = v.id;
                }
            });
            $.each( $(".flavors"), function (k, v){
                if (v.innerHTML.replace(/ /g,'') == default_param["flavor"]) {
                    default_param["flavor"] = v.id;
                }
            });
            $.each( $(".networks"), function (k, v){
                if (v.innerHTML.replace(/ /g,'') == default_param["network"]) {
                    default_param["network"] = v.id;
                }
            });
            $.each( $(".protocols"), function (k, v){
                if (v.innerHTML.replace(/ /g,'') == default_param["protocol"]) {
                    default_param["protocol"] = v.id;
                }
            });
            $.each( $(".policies"), function (k, v){
                if (v.innerHTML.replace(/ /g,'') == default_param["policy"]) {
                    default_param["policy"] = v.id;
                }
            });
            var temp = [];
            $.each( $(".places"), function (k, v){
                var place_selected = $('#course_places').text().replace(/ /g,'').split(",");

                for (i=0;i<place_selected.length;i++){
                    if (v.innerHTML.replace(/ /g,'') == place_selected[i]) {
                        temp.push(v.id);
                    }
                }
            });
            default_param["place"] = temp;

        }

        function add_day_delta(date_str, days){
            var start_date = new Date(Date.parse(date_str));
            start_date.setDate(start_date.getDate() + days);
            var month = start_date.getMonth() + 1;
            if (month<10)
                month = '0' + month;
            var day = start_date.getDate();
            if (day<10)
                day = '0' + day;
            var new_date_str = start_date.getFullYear() + "-"
                    + month + "-" + day;
            return new_date_str
        }

        function get_week_timetable(week_start_date){
            if(! lessons_lists[week_start_date]){
                $.ajax({
                    url: "{{ url_for('edu.get_timetable', id=course.id )}}",
                    type: "POST",
                    data: {week_start_date: week_start_date},
                    async: false,
                    global: true,
                    success: function (data) {
                        $("#week_timetable").html(data);
                        get_all_lessons($("#hidden_start_date").val());
                        change_lessons_lists["add_lessons_lists"][$("#hidden_start_date").val()] = {};
                        change_lessons_lists["delete_lessons_lists"][$("#hidden_start_date").val()] = {}
                    }
                });
            }
            else{
                $.ajax({
                    url: "{{ url_for('edu.get_timetable', id=course.id )}}",
                    type: "POST",
                    data: {week_start_date: week_start_date},
                    async: false,
                    global: true,
                    success: function (data) {
                        $("#week_timetable").html(data);
                        $.each( $(".schedule_item") , function(k, v){
                            if (lessons_lists[week_start_date][v.id] == true) {
                                if (! $(this).hasClass("select_item"))
                                    $(this).addClass("select_item")
                            }
                            else{
                                if ($(this).hasClass("select_item"))
                                    $(this).removeClass("select_item")
                            }
                        });
                    }
                });
            }
            var start_date = add_day_delta(week_start_date, 0);
            var end_date = add_day_delta(week_start_date, 6);
            if( start_date <= course_start_date && end_date >= course_start_date )
                document.getElementById("link_last_week").style.visibility = "hidden";
            else
                 document.getElementById("link_last_week").style.visibility = "visible";
            if( start_date <= course_end_date && end_date >= course_end_date )
                 document.getElementById("link_next_week").style.visibility = "hidden";
            else
                document.getElementById("link_next_week").style.visibility = "visible";
        }

        function getPeriodTime(period) {
            // FIXME: we use the front-end data to get the period's time.
            // When other administrators change the timetable, may lead a bug
            // The bug:the end time of a lesson whose time span is not more than 1 days may be less than the begin time
            var ret = {start: "", end: ""};
            var time = $("#period_" + period).html();
            if (time != null && time != undefined) {
                time = time.split("&nbsp;");
                time = time[time.length - 1];
                time = time.split("-");
                if (time.length == 2) {
                    ret.start = time[0];
                    ret.end = time[1];
                }
            }
            return ret;
        }

        function getStartdate() {
            switch ($("input[name=frequency]:checked").val()) {
                case "weekly":
                    return $("select[name=start_weekday]").val();
                case "daily":
                    return 0;
                default:
                    return $("div.date_control input[name=start_date]").val();
            }
        }

        // 获取结束日期或结束星期几
        function getEnddate() {
            switch ($("input[name=frequency]:checked").val()) {
                case "weekly":
                    return parseInt($("select[name=end_weekday]").val());
                case "daily":
                    return 0;
                default:
                    return $("div.date_control input[name=end_date]").val();
            }
        }

        // 获取开始时间或开始节数的开始时间
        function getStarttime() {
            var starttime = null;
            if ($("input[name=start_time_type]:checked").val() == "period") {
                starttime = getPeriodTime($("select[name=start_period_id]").val()).start;
            } else {
                starttime = $("input[name=start_time]").val();
            }
            return starttime;
        }

        // 获取结束时间或结束节数的结束时间
        function getEndtime() {
            var endtime = null;
            if ($("input[name=end_time_type]:checked").val() == "period") {
                endtime = getPeriodTime($("select[name=end_period_id]").val()).end;
            } else {
                endtime = $("input[name=end_time]").val();
            }
            return endtime;
        }

        // 检查课时结束是否合法
        function checkEnd() {
            var startdate = getStartdate();
            var enddate = getEnddate();
            var starttime = getStarttime();
            starttime = parseInt(starttime.replace(":", ""));
            var endtime = getEndtime();
            endtime = parseInt(endtime.replace(":", ""));
            return enddate > startdate || ( enddate == startdate && endtime > starttime)
        }

        function filter_flavor() {
            params_lists["flavor"] = [];
            image_id = $("#form_course_image").val();
            min_ram = Number($("#image-storage-" + image_id + "-ram").html());
            min_disk = Number($("#image-storage-" + image_id + "-disk").html());
            flavors = $("#get_course_flavor_list").children();
            first = $("#course_flavor").html(); // use to record the first option which meet damand
            flag = 0;
            change_first = null;
            for (var i=0; i<flavors.length; i++) {
                description = $(flavors[i]).html().replace(/ /g,'');
                description = description.split("-");
                flavor_info = description[description.length - 1];
                flavor_info = $.trim(flavor_info);
                flavor_info = flavor_info.split("|");
                ram = Number(flavor_info[1].substr(0, flavor_info[1].length-2));
                disk = Number(flavor_info[2].substr(0, flavor_info[2].length-2));
                if (ram < min_ram || disk < min_disk)
                    $(flavors[i]).wrap("<span style='display:none'></span>");
                else {
                    if(change_first == null ){
                        change_first = $(flavors[i]).html();
                    }
                    if (first.replace(/ /g,'') == $(flavors[i]).html().replace(/ /g,'')) {
                        flag = 1;
                    }
                    params_lists["flavor"].push({id: $(flavors[i]).attr("id"), text: $(flavors[i]).html()});
                }
            };
            // make select2 to select the specified option
            if (flag == 0 && change_first != null){
                default_param["flavor"] = change_first.replace(/ /g,'');
                find_id();
                $("#form_course_flavor").val(default_param["flavor"]);
                $("#course_form").submit();
            }
        }



        $(document).ready(function () {

            $.fn.editable.defaults.mode = 'inline';

            init_select_list();

            get_all_lessons($("#hidden_start_date").val());
            change_lessons_lists["add_lessons_lists"][$("#hidden_start_date").val()] = {};
            change_lessons_lists["delete_lessons_lists"][$("#hidden_start_date").val()] = {};

            default_param["image"] = $('#course_image').text().replace(/ /g,'');
            default_param["flavor"] = $('#course_flavor').text().replace(/ /g,'');
            default_param["network"] = $('#course_network').text().replace(/ /g,'');
            default_param["protocol"] = $('#course_protocol').text().replace(/ /g,'');
            default_param["policy"] = $('#course_policy').text().replace(/ /g,'');
            default_param["place"] = $('#course_places').text().replace(/ /g,'');
            filter_flavor();
            find_id();
            $('#course_owner').editable({
                type: 'select2',
                select2: {
                    width: 200,
                    language: "zh-CN",
                    allowClear: true,
                    minimumInputLength: 2,
                    placeholder: "{{ course.owner.fullname }}",
                    ajax: {
                        url: "{{ url_for('edu.teachers') }}",
                        dataType: 'json',
                        quietMillis: 300,
                        data: function (term, page) { // page is the one-based page number tracked by Select2
                            return {
                                q: term, //search term
                                page: page // page number
                            };
                        },
                        results: function (data, page) {
                            var result = data.data;
                            var more = page < result.pages; // whether or not there are more results available
                            // notice we return the value of more so Select2 knows if more results can be loaded
                            return {results: result.items, more: more};
                        },
                        cache: true
                    },
                    formatResult: function (obj) {
                        return obj.username + "-" + obj.fullname;
                    },
                    formatSelection: function (obj) {
                        return obj.fullname;
                    },
                    id: function (obj) {
                        return obj.id;
                    }
                }
            });

            $('#course_places').editable({
                type: 'select2',
                value: default_param["place"],
                source: params_lists["place"],
                viewseparator: ',',
                select2: {
                    width: 200,
                    language: "zh-CN",
                    allowClear: true,
                    multiple: true,
                }
            });

            $('#course_image').editable({
                type: 'select2',
                value: default_param["image"],
                source: params_lists["image"],
                select2: {
                    width: 200,
                }
            });

            $('#course_flavor').editable({
                type: 'select2',
                value: default_param["flavor"],
                source: params_lists["flavor"],
                select2: {
                    width: 200,
                }
            });

            $('#course_network').editable({
                type: 'select2',
                value: default_param["network"],
                source: params_lists["network"],
                select2: {
                    width: 200,
                }
            });

            $('#course_protocol').editable({
                type: 'select2',
                value: default_param["protocol"],
                source: params_lists["protocol"],
                select2: {
                    width: 200,
                }
            });

            $('#course_policy').editable({
                type: 'select2',
                value: default_param["policy"],
                source: params_lists["policy"],
                select2: {
                    width: 200,
                }
            });

            $(".date-editable").editable({
                type: 'adate',
                date: {
                    //datepicker plugin options
                    format: 'yyyy-mm-dd',
                    viewformat: 'yyyy-mm-dd',
                    weekStart: 1
                }
            });

            // editable plugin init
            $('.text-editable').editable('option', 'validate', function (v) {
                if (!v) return '不能为空！';
            });

            $('.date-editable').editable('option', 'validate', function (v) {
                if (!v) return '不能为空！';
            });

            $('.list-editable').editable('option', 'validate', function (v) {
                if (!v) return '不能为空！';
            });

            $('.number-editable').editable('option', 'validate', function (v) {
                if (!v) {
                    return '不能为空！';
                }
                else if (!$.isNumeric(v)) {
                    return '请输入数字！'
                } else if (parseInt(v) < 0 || parseInt(v) != v)
                    return '请输入非负整数！'
            });

            $('.text-editable, .number-editable , .date-editable, .list-editable').on('save', function(e, editable) {
                var target = e.currentTarget;
                $("#form_"+ target.id).val(editable.newValue);
                $("#course_form").submit();
            });

            $("#save_timetable").click(function() {
                $.ajax({
                    url: "{{ url_for('edu.save_timetable', id=course.id )}}",
                    type: "POST",
                    contentType: "application/json",
                    data: $.toJSON(change_lessons_lists),
                    async: false,
                    global: true,
                    success: function (responseJson) {
                        var data = responseJson.message;
                        location.reload()

                    }
                });
            });

            $("#add_timetable").click(function(){
                $("#add_lessons_modal").modal("show");
            });


            // 数据校验规则
            // 结束 weekday 大于等于开始 weekday
            $.validator.addMethod("end_weekday", function (value, element) {
                return this.optional(element) || value >= $("select[name=start_weekday]").val()
            }, "结束日期必须大于等于开始日期");
            // 结束日期大于等于开始日期
            $.validator.addMethod("end_date", function (value, element) {
                return this.optional(element) || value >= $("div.date_control input[name=start_date]").val()
            }, "结束日期必须大于等于开始日期");
            // 结束节数时间大于等于开始时间
            $.validator.addMethod("end_period", function (value, element) {
                return this.optional(element) || checkEnd();
            }, "结束日期和时间必须大于开始日期和时间");
            // 结束时间大于开始时间
            $.validator.addMethod("end_time", function (value, element) {
                return this.optional(element) || checkEnd();
            }, "结束日期和时间必须大于开始日期和时间");

            $(".week-date-picker").datepicker({
                language: "zh-CN",
                format: "yyyy-mm-dd",
                autoclose: true,
                todayHighlight: true
            }).on(ace.click_event, function () {
                $(".datepicker").css("z-index", "9999");
            });

            $(".week-date-picker").attr("data-date-format", "yyyy-mm-dd").on("changeDate",function (ev) {
                // 限制开始时间和结束时间范围
                var weekday;
                if( ev.date.getDay() == 0)
                    weekday = 6;
                else
                    weekday = ev.date.getDay() - 1;
                var start_week_day = add_day_delta(ev.date.toLocaleDateString(), -weekday);
                var end_week_day = add_day_delta(start_week_day, 6);
                $("#hidden_start_date").val(start_week_day);
                var start_week_day_str = start_week_day.split("-")[0] + "年" + start_week_day.split("-")[1] + "月" + start_week_day.split("-")[2] + "日";
                var end_week_day_str = end_week_day.split("-")[0] + "年" + end_week_day.split("-")[1] + "月" + end_week_day.split("-")[2] + "日";
                var week_range = start_week_day_str + "  --  " + end_week_day_str;
                $("#week_date_range").val(week_range);
                get_week_timetable(start_week_day);
            });

            $(".week-date-picker").datepicker("setStartDate", course_start_date);
            $(".week-date-picker").datepicker("setEndDate", course_end_date);

            $(".time-picker").timepicker({
                minuteStep: 1,
                showSeconds: false,
                showMeridian: false
            }).on(ace.click_event, function () {
                $(".bootstrap-timepicker-widget").css("z-index", "9999");
            }).next().on(ace.click_event, function () {
                $(this).prev().focus();
            });

            $(".date-picker").datepicker({
                language: "zh-CN",
                format: "yyyy-mm-dd",
                autoclose: true,
                todayHighlight: true
            }).on(ace.click_event, function () {
                $(".datepicker").css("z-index", "9999");
            }).attr("data-date-format", "yyyy-mm-dd").on('changeDate', function (ev) {
                // 限制开始时间和结束时间范围
                if ($("div.date_control input[name=start_date]").val() != null) {
                    $("div.date_control input[name=end_date]").datepicker("setStartDate", $("div.date_control input[name=start_date]").val());
                }
                if ($("input[name=end_date]").val() != null) {
                    $("div.date_control input[name=start_date]").datepicker("setEndDate", $("div.date_control input[name=end_date]").val());
                }
            });

            // 限制开始和结束日期不超过课程日期范围
            $("div.date_control input[name=start_date]").datepicker("setStartDate", course_start_date);
            $("div.date_control input[name=end_date]").datepicker("setEndDate", course_end_date);

            // 频率为每周时, 修改开始日期时自动调整结束日期, 确保结束日期>=开始日期
            $("select[name=start_weekday]").change(function () {
                var day = $(this).val();
                $("select[name=end_weekday]").val('').select2('val', "");
                $("select[name=end_weekday]").find('option').each(function (index) {
                    if ($(this).val() < day) {
                        $(this).hide();
                    } else {
                        $(this).show();
                    }
                    if ($(this).val() == day) {
                        $("select[name=end_weekday]").val($(this).val());
                    }
                });
            });

            // 界面处理 frequency
            $("input[name=frequency]").change(function () {
                switch ($(this).val()) {
                    case "weekly":
                        $("select[name$=weekday]").attr("required", true).show();
                        $("select[name$=weekday]").parent().show();
                        $("div.date_control input[name$=date]").removeAttr("required");
                        $("div.date_control input[name$=date]").parent().hide();
                        $("input[name=frequency][value='weekly']").attr("checked",true);
                        $("input[name=frequency][value='daily']").attr("checked",false);
                        $("input[name=frequency][value='once']").attr("checked",false);
                        break;
                    case "daily":
                        $("select[name$=weekday]").removeAttr("required");
                        $("select[name$=weekday]").parent().hide();
                        $("div.date_control input[name$=date]").removeAttr("required");
                        $("input[name=frequency][value='weekly']").attr("checked",false);
                        $("input[name=frequency][value='daily']").attr("checked",true);
                        $("input[name=frequency][value='once']").attr("checked",false);
                        break;
                    default:
                        $("select[name$=weekday]").removeAttr("required").hide();
                        $("select[name$=weekday]").parent().show();
                        $("div.date_control input[name$=date]").attr("required", true).parent().show();
                        $("input[name=frequency][value='weekly']").attr("checked",false);
                        $("input[name=frequency][value='daily']").attr("checked",false);
                        $("input[name=frequency][value='once']").attr("checked",true);
                        break;
                }
            });
            // 界面处理 start_time_type
            $("input[name=start_time_type]").change(function () {
                if ($(this).val() == "period") {
                    $("select[name=start_period_id]").attr("required", true).show();
                    $("input[name=start_time]").removeAttr("required").parent().hide();
                    $("input[name=start_time_type][value='period']").attr("checked",true);
                    $("input[name=start_time_type][value='customized']").attr("checked",false);
                } else {
                    $("select[name=start_period_id]").removeAttr("required").hide();
                    $("input[name=start_time]").attr("required", true).parent().show();
                    $("input[name=start_time_type][value='period']").attr("checked",false);
                    $("input[name=start_time_type][value='customized']").attr("checked",true);
                }
            });
            // 界面处理 end_time_type
            $("input[name=end_time_type]").change(function () {
                if ($(this).val() == "period") {
                    $("select[name=end_period_id]").attr("required", true).show();
                    $("input[name=end_time]").removeAttr("required").parent().hide();
                    $("input[name=end_time_type][value='period']").attr("checked",true);
                    $("input[name=end_time_type][value='customized']").attr("checked",false);
                } else {
                    $("select[name=end_period_id]").removeAttr("required").hide();
                    $("input[name=end_time]").attr("required", true).parent().show();
                    $("input[name=end_time_type][value='period']").attr("checked",false);
                    $("input[name=end_time_type][value='customized']").attr("checked",true);
                }
            });

            $("select[name=start_period_id]").change(function(){
                $("select[name=start_period_id]").val($(this).val());
            });

            $("select[name=end_period_id]").change(function(){
                $("select[name=end_period_id]").val($(this).val());
            });

            $("input[name='end_time']").change(function(){
                $("input[name='end_time']").val($(this).val());
            });

            $("input[name='start_time']").change(function(){
                $("input[name='start_time']").val($(this).val());
            })

            $("button[id=comfirm_add_lesson]").click(function () {
                $("form[id=lessons_form]").validate({
                    errorPlacement: function (error, element) {
                        if ($(element).hasClass('date-picker') || $(element).hasClass('time-picker')) {
                            error.insertAfter($(element).parent());
                        } else {
                            error.insertAfter(element);
                        }
                    }
                });
                if ($("form[id=lessons_form]").valid()) {
                    $("form[id=lessons_form]").submit();
                    $("#add_lessons_modal").modal("hide");
                }
            });

            $("#link_last_week").click(function(){
                var date_str = $("#hidden_start_date").val();
                var start_date = add_day_delta(date_str, -7);
                var end_date = add_day_delta(start_date, 6);
                $("#hidden_start_date").val(start_date);
                var start_date_str = start_date.split("-")[0] + "年" + start_date.split("-")[1] + "月" + start_date.split("-")[2] + "日";
                var end_date_str = end_date.split("-")[0] + "年" + end_date.split("-")[1] + "月" + end_date.split("-")[2] + "日";
                var week_range = start_date_str + "  --  " + end_date_str;
                $("#week_date_range").val(week_range);
                get_week_timetable(start_date);
            });


            // link to next week scheduler
            $("#link_next_week").click(function(){
                var date_str = $("#hidden_start_date").val();
                var start_date = add_day_delta(date_str, 7);
                var end_date = add_day_delta(start_date, 6);
                $("#hidden_start_date").val(start_date);
                var start_date_str = start_date.split("-")[0] + "年" + start_date.split("-")[1] + "月" + start_date.split("-")[2] + "日";
                var end_date_str = end_date.split("-")[0] + "年" + end_date.split("-")[1] + "月" + end_date.split("-")[2] + "日";
                var week_range = start_date_str + "  --  " + end_date_str;
                $("#week_date_range").val(week_range);
                get_week_timetable(start_date);
            });

            $("#edit_timetable").click(function () {
                var is_edit = true;
                if ($("#week_timetable").hasClass("edit_schedule_table")) {
                    $("#week_timetable").removeClass("edit_schedule_table");
                    $("#edit_timetable").attr("title", "修改");
                    $("#edit_timetable").html('<i class="ace-icon fa fa-pencil-square-o fa-lg fa-fw" aria-hidden="true"></i> ')
                    is_edit = true;
                }
                else{
                    $("#edit_timetable").attr("title", "撤销");
                    $("#edit_timetable").html('<i class="ace-icon fa fa-save fa-lg fa-reply" aria-hidden="true"></i>')
                    $("#week_timetable").addClass("edit_schedule_table");
                    is_edit = false;
                }
                if(is_edit){
                    document.getElementById("save_timetable").style.display = 'none';
                    for (i in  change_lessons_lists["add_lessons_lists"])
                        change_lessons_lists["add_lessons_lists"][i] = {}
                    for (i in  change_lessons_lists["delete_lessons_lists"])
                        change_lessons_lists["delete_lessons_lists"][i] = {}
                    $(".schedule_table .schedule_item").unbind();
                    location.reload()
                }

                else{
                    document.getElementById("save_timetable").style.display = 'inline';
                    $(".schedule_table .schedule_item").hover(
                        function() {
                            this.style.backgroundColor = "#ABCFE7";
                        },
                        function() {
                            if($(this).hasClass("select_item")){
                                this.style.backgroundColor = "#2283C5"
                            }
                            else{
                                this.style.backgroundColor = ''
                            }
                        }
                     );

                    $(".schedule_table .schedule_item").click(function(){
                        if($(this).hasClass("select_item")){
                            $(this).removeClass("select_item");
                            lessons_lists[$("#hidden_start_date").val()][this.id] = false;
                            if($(this).hasClass("saved_item"))
                                change_lessons_lists["delete_lessons_lists"][$("#hidden_start_date").val()][this.id] = this.id;
                            else
                                delete change_lessons_lists["add_lessons_lists"][$("#hidden_start_date").val()][this.id];
                        }
                        else{
                            $(this).addClass("select_item");
                            lessons_lists[$("#hidden_start_date").val()][this.id] = true;
                            if(! $(this).hasClass("saved_item"))
                                change_lessons_lists["add_lessons_lists"][$("#hidden_start_date").val()][this.id] = this.id;
                            else
                                delete change_lessons_lists["delete_lessons_lists"][$("#hidden_start_date").val()][this.id];
                        }
                    });
                }
            });


            /*
             *  supply desktops number validator
             */
            jQuery.validator.addClassRules("supply_desktops_number", {
                required: true,
                positiveinteger: true
            });

            $("#supply_desktop_form").validate();




            binding_student_select2 = $("#binding_student_select2").select2({
                width: "60%",
                language: "zh-CN",
                allowClear: true,
                placeholder: "搜索学生",
                ajax: {
                    url: url_binding,
                    dataType: 'json',
                    quietMillis: 300,
                    data: function (term, page) { // page is the one-based page number tracked by Select2
                        return {
                            q: term, //search term
                            page: page // page number
                        };
                    },
                    results: function (data, page) {
                        var result = data.data;
                        var more = page < result.pages; // whether or not there are more results available
                        // notice we return the value of more so Select2 knows if more results can be loaded
                        return {results: result.items, more: more};
                    },
                    cache: true
                },
                formatResult: function (obj) {
                    return obj.username + "-" + obj.fullname;
                },
                formatSelection: function (obj) {
                    return obj.username;
                },
                id: function (obj) {
                    return obj.id;
                }
            });

            $("table th input[type=checkbox]").change(function () {
                var checked = this.checked;
                $(this).closest("table").find("td input[type=checkbox]").each(function () {
                    this.checked = checked;
                });
            });

            // students table
            $("#students_table").dataTable({
                "language": {
                    "url": "{{ url_for('static', filename='i18n/jquery.dataTables.json') }}"
                },
                "aoColumns": [
                    { "bSortable": false },
                    null, null
                ],
                "aaSorting": []
            });

            // update students
            $("#studentfile").ace_file_input({
                droppable: false,
                onchange: null,
                thumbnail: false
            });

            $("#search_student").select2({
                width: "100%",
                language: "zh-CN",
                allowClear: true,
                placeholder: "搜索教师",
                multiple: true,
                separator: ",",
                minimumInputLength: 2,
                ajax: {
                    url: "{{ url_for('edu.students') }}",
                    dataType: 'json',
                    quietMillis: 300,
                    data: function (term, page) { // page is the one-based page number tracked by Select2
                        return {
                            q: term, //search term
                            page: page // page number
                        };
                    },
                    results: function (data, page) {
                        var result = data.data;
                        var more = page < result.pages; // whether or not there are more results available
                        // notice we return the value of more so Select2 knows if more results can be loaded
                        return {results: result.items, more: more};
                    },
                    cache: true
                },
                formatResult: function (obj) {
                    return obj.username + "-" + obj.fullname;
                },
                formatSelection: function (obj) {
                    return obj.fullname;
                },
                id: function (obj) {
                    return obj.id;
                }
            });

            $("#add_students").click(function () {
                $("#add_students_dialog").modal("show");
            });

            $("#confirm_add_students").click(function () {
                $("#students_form").attr("method", "POST").submit();
                $("#add_students_dialog").modal("hide");
            });

            $("#studentfile").bind('change', function () {
                var msg = "";
                var filepath = "";
                try {
                    filepath = $("#studentfile").val();
                    if (filepath == "") {
                        msg = "请选择要导入的选课名单文件";
                    }
                    else {
                        var suffix_index = filepath.lastIndexOf(".");
                        if (suffix_index >= 0) {
                            var suffix = filepath.substring(suffix_index, filepath.length).toLocaleUpperCase();
                            suffix = suffix.trim();
                            if (suffix == ".XLS" || suffix == ".XLSX") {
                                var filesize = 0;
                                // using html5 to check file size, some browsers not supported
                                filesize = $(this)[0].files[0].size; //size in kb
                                filesize = filesize / 1048576; //size in mb
                                if (filesize > 10) {
                                    msg = "文件超过 10 MB ，可能无法导入到选课名单！";
                                }
                            } else {
                                msg = "仅支持 excel (.xls 或 .xlsx) 文件";
                            }
                        }
                        else {
                            msg = "仅支持 excel (.xls 或 .xlsx) 文件";
                        }
                    }
                } catch (e) {
                    msg = "未知文件大小，请确保文件大小不超过 10 MB";
                }
                $("#upload_message").text(msg);
                if (msg != "") {
                    $("#upload_message").removeClass("hidden");
                } else {
                    $("#upload_message").addClass("hidden");
                }
            });

            $("#upload_users_dialog_pop").click(function () {
                $('#userfile').ace_file_input('reset_input');
                $("#upload_users_dialog").modal("show");
            });

            $("#upload_file").click(function () {
                var options = {
                    success: function () {
                        location.reload();
                    },
                    error: function (request, message, error) {
                        alert("所选择的文件存在错误，无法完整导入名单");
                    },
                    url: "{{ url_for('edu.upload_students', id=course.id) }}",
                    type: "post",
                    dataType: "json"
                };
                //$("#upload_form").ajaxSubmit(options);
                $("#upload_form").submit();
            });


            $("#delete_students").click(function () {
                selected_students = [];
                $("#students_table td input[type=checkbox]").each(function () {
                    if (this.checked) {
                        var student_id = this.id.split('_')[1];
                        selected_students.push(student_id);
                    }
                });
                if (selected_students.length > 0) {
                    $("#delete_student_confirm_dialog").modal("show");
                }
            });

            $("#delete_students_from_input").click(function () {
                selected_students = $("#search_student").val().split(",");
                if (selected_students.length > 0) {
                    $("#delete_student_confirm_dialog").modal("show");
                }
            });

            $("#confirm_delete_student").click(function () {
                $.ajax({
                    url: "{{ url_for('edu.delete_students', id=course.id) }}",
                    type: "DELETE",
                    contentType: "application/json",
                    data: $.toJSON(selected_students),
                    success: function () {
                        location.reload();
                    }
                });
            });


            $("#desktops_table").dataTable({
                "language": {
                    "url": "{{ url_for('static', filename='i18n/jquery.dataTables.json') }}"
                },
                "aoColumns": [
                    // {"bSortable": false},
                    null, null, null, null, null
                ],
                "aaSorting": []
            });


{##}
            $('#supply_desktop').click(function() {
                $("#supply_desktop_confirm_dialog").modal("show");
            });

            // confirm supply
            $("#confirm_supply").click(function () {
                if ($("#supply_desktop_form").valid()) {
                    $("#supply_desktop_confirm_dialog").modal('hide');
                    var course_id = $('#course_id').val();
                    var count_text = $('#desktop_count').val();
                    var count = Number(count_text);

                    var param = new Object();
                    param.course_id = course_id;
                    param.count = count;
                    tmp = JSON.stringify(param);
                    $.ajax({
                        url: "{{ url_for('desktop.supply_desktop') }}",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(param),
                        success: on_supply_desktop_success,
                        error: on_supply_desktop_error
                    });
                }
            });


            function on_supply_desktop_success(responseJson) {
                var status = responseJson.status;
                var data = responseJson.data;
                switch (status) {
                    case "success":
                        $.gritter.add({
                            text: "补充课程桌面成功！",
                            class_name: 'gritter-success'
                        });
                        location.reload()
                        break;
                    case "fail":
                        if (data == "no current lesson") {
                            $.gritter.add({
                                text: "补充课程桌面失败，当前课程不在上课时段!",
                                class_name: 'gritter-warning'
                            });

                        } else if (data == "course not exist") {
                            $.gritter.add({
                                text: "补充课程桌面失败，课程不存在!",
                                class_name: 'gritter-warning'
                            });
                        } else if (data == "resource exceed system limit") {
                            $.gritter.add({
                                text: "补充课程桌面失败，资源使用超出系统上限!",
                                class_name: 'gritter-error'
                            });
                        } else if (data.msg == "part exceed system limit") {
                            var actual_count = data.actual_count
                            $.gritter.add({
                                text: "由于资源限制，只能补充" + actual_count + "个桌面!",
                                class_name: 'gritter-warning'
                            });
                        } else if (data == "parameter format error") {
                            $.gritter.add({
                                text: "桌面数量格式不正确，请输入正整数!",
                                class_name: 'gritter-error'
                            });
                        }
                        break;
                    case "error":
                        if (data == "server error") {
                            $.gritter.add({
                                text: "补充课程桌面失败，处理出错!",
                                class_name: 'gritter-error'
                            });
                        }
                        break;
                }
            }

            function on_supply_desktop_error(responseJson) {
                $.gritter.add({
                    text: "补充课程桌面失败，处理出错!",
                    class_name: 'gritter-error'
                });
            }
        });

        var desktopid;

        function on_unbunding_click(desktop_id){
            desktopid = desktop_id;
            $("#unbunding_dialog").modal("show");
        }

        $("#confirm_unbunding").click(function() {
            doUnbunding(desktopid);
            $("#unbunding_dialog").modal("hide");
        });

        function doUnbunding(desktop_id){
            var url_template = "{{ url_for('desktop.unbunding_desktop', id=0) }}";
            url = url_template.replace('0', desktop_id);
            $.ajax({
                url:  url,
                type: "POST",
                success: on_unbunding_success,
                error: on_unbunding_error
            });
        }

        function on_unbunding_success(request, msg, e) {
            var json_result = $.parseJSON(e.responseText);
            if (json_result) {
                var status = json_result.status;
                var successdata = json_result.data.success_id;
                var faildata = json_result.data.fail_id;
                switch (status) {
                    case "success":
                        // 修改user_table

                        $("#desktop_owner_"+successdata)
                            .html('无人占用 <span style="float: right"><a href="javascript:void(0)" id="owner-binding"  onclick="on_binding_click('+ successdata +')">绑定</a></span>')
                      // 显示提示信息
                        $.gritter.add({
                            // (string | mandatory) the text inside the notification
                            text: '桌面&nbsp;'+ $("#desktop_name_"+ successdata).text() +'&nbsp;信息修改成功',
                            class_name: 'gritter-success'
                        });
                        break;
                    case "fail":
                        // display server side form error messages
                        $.gritter.add({
                            // (string | mandatory) the text inside the notification
                            text: '服务器异常',
                            class_name: 'gritter-error'
                        });
                        break;
                    default:
                        $.gritter.add({
                            // (string | mandatory) the text inside the notification
                            text: '服务器异常',
                            class_name: 'gritter-error'
                        });
                }
            }
        }

        function on_unbunding_error(response) {
            $.gritter.add({
                // (string | mandatory) the text inside the notification
                text: '解除绑定过程中出现错误',
                class_name: 'gritter-error'
            });
        }

        $("#error-info-close").click(function(){
            $("#error-info").hide();
        });

        function on_binding_click(desktop_id){
            desktopid = desktop_id;
            $("#binding_dialog").modal("show");
            $("#binding_student_select2").select2("val", "");
            $("#error-info").hide();
        }


        $("#confirm_binding").click(function() {
            if ($("#binding_student_select2").val() == "" ){
                $("#error-info").show();
            }
            else{
                dobinding(desktopid);
                $("#binding_dialog").modal("hide");
            }

        });

        function dobinding(desktop_id){
            var studentbinding = $("#binding_student_select2").val();
            var url_template = "{{ url_for('desktop.binding_desktop', id=0) }}";
            url = url_template.replace('0', desktop_id);
            $.ajax({
                url:  url,
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(studentbinding),
                success: on_binding_success,
                error: on_binding_error
            });
        }

        function on_binding_success(request, msg, e) {
            var json_result = $.parseJSON(e.responseText);
            if (json_result) {
                var status = json_result.status;
                var successdata = json_result.data.success_id;
                var faildata = json_result.data.fail_id;
                var successname = json_result.data.success_name;
                switch (status) {
                    case "success":
                        // 修改user_table

                        $("#desktop_owner_"+successdata)
                            .html(successname + ' <span style="float: right"> <a href="javascript:void(0)" id="owner-unbunding"  onclick="on_unbunding_click('+ successdata +')">解绑</a></span>')
                      // 显示提示信息
                        $.gritter.add({
                            // (string | mandatory) the text inside the notification
                            text: '桌面&nbsp;'+ $("#desktop_name_"+ successdata).text() +'&nbsp;信息修改成功',
                            class_name: 'gritter-success'
                        });
                        break;
                    case "fail":
                        // display server side form error messages
                        $.gritter.add({
                            // (string | mandatory) the text inside the notification
                            text: '服务器异常',
                            class_name: 'gritter-error'
                        });
                        break;
                    default:
                        $.gritter.add({
                            // (string | mandatory) the text inside the notification
                            text: '服务器异常',
                            class_name: 'gritter-error'
                        });
                }
            }
        }
        function on_binding_error(response) {
            $.gritter.add({
                // (string | mandatory) the text inside the notification
                text: '用户绑定过程中出现错误',
                class_name: 'gritter-error'
            });
        }

        // 获取节数时间


    </script>
{% endblock %}
