{% extends 'teachers/layout.html' %}

{% import 'bootstrap/wtf.html' as wtf %}

{% block title %}镜像管理{% endblock %}

{% block inline_styles %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static',filename='css/bootstrap-timepicker.min.css') }}"
          xmlns="http://www.w3.org/1999/html">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/jquery-ui.min.css') }}"/>
    <link ref="stylesheet" href="{{ url_for('static', filename='css/chosen.css') }}" />

    <style type="text/css">
        .vinzor_middle {
            text-align: center;
        }

        .vinzor_canvas_body {
            width: 100%;
            height: 812px;
        }

        .bar {
            background-image: linear-gradient(45deg, rgba(255, 255, 255, 0.15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.15) 75%, transparent 75%, transparent) !important;
            padding-top: 3px;
        }

        .progress {
            margin-bottom: 0px !important;
            height: 25px !important;
        }
        .disableCss{
            pointer-events:none;
            color:#afafaf;
            cursor:default
        }
    </style>

{% endblock %}

{% block page_content %}
    <div class="page-header"><h1>镜像制作</h1></div>
    <div class="widget-box">
        <div class="widget-header">
            <h4 class="widget-title">镜像实例</h4>
        </div>
        <div class="widget-body no-padding">
            <div class="widget-toolbox padding-10">
                <div class="row">
                    <div class="col-md-6">
                        <div class="action-buttons">
                            <a id="generate_instance" href="javascript:void(0)"><i class="ace-icon fa fa-plus-circle"></i> 生成实例 </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="widget-main no-padding">
                <table id="table_instance_list" class="table table-striped table-bordered table-hover">
                    <thead>
                    <tr>
                        <th>名称</th>
                        <th>配置</th>
                        <th>IP</th>
                        <th>状态</th>
                        <th style="width:200px">操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for instance in instance_list %}
                        <tr>
                            <td id="instance_name_{{ instance.name }}">
                                {% if instance.vm_ref and instance.desktop_state == 'ACTIVE'%}
                                    <a href='#instance_block_header'
                                       onclick="generate_vnc_console('{{get_console_by_vmid(instance.vm_ref) }}','{{instance.vm_ref}}','{{ instance.name }}')">{{ instance.name }}</a>
                                {% else %}
                                    {{ instance.name }}
                                {% endif %}
                            </td>
                            <td id="instance_description_{{ instance.name }}">
                                <span>{{ get_flavor_by_desktopid(instance.id) }}</span>
                            </td>
                            <td id="instance_ip_{{ instance.name }}">{% if
                                instance.floating_ip %}{{ instance.floating_ip }}{% else
                                %}未分配{% endif %}</td>
                            <td id="instance_status_{{ instance.name }}"
                                class='hidden-480'>
                                {% if instance.desktop_state == 'ACTIVE' %}已启动
                                {% elif instance.desktop_state == 'SHUTOFF' or instance.desktop_state == "SUSPENDED"%} 已关闭
                                {% elif instance.desktop_state == 'ERROR' %} ERROR
                                {% elif instance.desktop_state == "STARTING" or instance.desktop_state == "SPAWNING" %}
                                    <div class="progress progress-striped active">
                                        <div class="progress-bar progress-bar-success" style="width: 100%;">启动中...</div>
                                    </div>
                                {% elif instance.desktop_state == 'STOPPING' or instance.desktop_state == "SUSPENDING"%}
                                    <div class="progress progress-striped active">
                                        <div class="progress-bar progress-bar-pink" style="width: 100%;">关闭中...</div>
                                    </div>
                                {% elif instance.desktop_state == 'DELETING' %}
                                    <div class="progress progress-striped active">
                                        <div class="progress-bar progress-bar-danger" style="width: 100%;">删除中...</div>
                                    </div>
                                {% endif %}
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <a href="javascript:void(0)" id="btn_snap_{{ instance.vm_ref }}" title="生成镜像"
                                       {% if instance.desktop_state != 'ACTIVE'%}class="disableCss"{% endif %}
                                       onclick="createSnapshotDialog('{{ instance.vm_ref }}')">
                                        <i class="ace-icon fa fa-check-circle-o bigger-130"></i>
                                    </a>

                                    <a href="javascript:void(0)" id="btn_inspower_{{ instance.vm_ref }}"
                                        {% if instance.desktop_state == 'ERROR' %}
                                            class="disableCss"
                                        {% elif instance.desktop_state == "STARTING" or instance.desktop_state == "SPAWNING" %}
                                            class="disableCss"
                                        {% elif instance.desktop_state == 'STOPPING' or instance.desktop_state == "SUSPENDING"%}
                                            class="disableCss"
                                        {% elif instance.desktop_state == 'DELETING' %}
                                            class="disableCss"
                                        {% endif %}
                                        {% if instance.desktop_state != 'ACTIVE' %}
                                            title="开机"
                                            onclick="power_on_dialog('{{ instance.vm_ref }}')">
                                            <i class="ace-icon fa fa-play-circle bigger-130"></i>
                                        {% else %}
                                            title="关机"
                                            onclick="power_off_dialog('{{instance.vm_ref }}')">
                                            <i class="ace-icon fa fa-power-off bigger-130"></i>
                                        {% endif %}
                                    </a>

                                    <a  title="删除" class="red" onclick="deleteInstanceDialog('{{ instance.vm_ref }}', '{{ instance.name }}')">
                                        <i class="ace-icon fa fa-trash-o bigger-130"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <br/>

    <div id="generate_dialog" class="modal fade">
        <div class="modal-dialog modal-user">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"
                            aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="generate_dialog_title">生成实例</h4>
                </div>

                <div class="modal-body">
                    <form id="launch_form" role="form" action="{{ url_for('teachers_image.launch_instance') }}" method="post">

                        <div class="form-group inst_name">
                            <label for="form-field-8">实例名称</label>
                            <input type="text" id="instance_name"
                                   name="instance_name" value=""
                                   placeholder="实例名称"
                                   style="width:100%"
                                   data-rule-isname="true" data-msg-isname='只能使用英文字符、数字、下划线、横杠和点'
                                   data-rule-required="true" data-msg-required='请输入实例名称'
                                   data-rule-maxlength="64" data-msg-maxlength='长度不能超过64个字符'/>
                        </div>
                        <div class="form-group based_img">
                            <label for="form-field-8">基础镜像</label>
                            <select id="launch_imageid"
                                    name="launch_imageid"
                                    class="select2"
                                    style="width:100%"
                                    data-placeholder="请选择"
                                    data-rule-required="true" data-msg-required='请选择镜像'>
                                <option value=""></option>
                                {% for image in image_list %}
                                    <option value="{{ image.id }}">{{ image.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group config">
                            <label for="form-field-8">配置&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <select id="image_flavor"
                                    name="image_flavor"
                                    class="select2"
                                    style="width:100%"
                                    data-placeholder="请选择"
                                    data-rule-required="true" data-msg-required='请选择配置'>
                                <option value=""></option>
                                {% for flavor in flavor_list %}
                                    <option value={{ flavor.id }}>{{ flavor.vcpus }}VCPU|{{ flavor.ram }}MB|{{ flavor.disk }}GB</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group config">
                            <label for="form-field-8">虚拟网络&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <select id="network_ref"
                                    name="network_ref"
                                    class="select2"
                                    style="width:100%"
                                    data-placeholder="请选择"
                                    data-rule-required="true" data-msg-required='请选择虚拟网络'>
                                <option value=""></option>
                                {% for network in network_list %}
                                    <option value={{ network.id }}>{{ network.name or network.id }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </form>
                </div>

                <div class="modal-footer">
                    <button id="confirm_generate" class="btn btn-success btn-sm" type="button">
                        <i class="ace-icon glyphicon glyphicon-ok"></i>生成
                    </button>
                    <button id="generator_reset" class="btn btn-danger btn-sm instance_reset" type="button">
                        <i class="ace-icon fa fa-undo"></i>重置
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row-fluid">
        <div class="widget-box">
            <div id="instance_block_header" class="widget-header">
                <h4 id="instance_header" class="widget-title">实例</h4>

                <div class="widget-toolbar">
                    <a href="javascript:void(0)" data-action="collapse">
                        <i class="ace-icon fa fa-chevron-up"></i>
                    </a>
                </div>
            </div>
            <div class="widget-body">
                <div class="widget-main" id="console_embed"></div>
            </div>
        </div>
    </div>

    <div style="display: none;">
        {% for image in image_list %}
            <div>
                <div id="{{ image.id }}_min_ram">{{ image.min_ram }}</div>
                <div id="{{ image.id }}_min_disk">{{ image.min_disk }}</div>
            </div>
        {% endfor %}
    </div>

    <span style="display:none;" id="vnc_console_href">{{ url_for('teachers_image.get_instance_console') }}</span>

    <!-- delete vm confirmation dialog -->
    <div id="delete_instance_confirm_dialog" class="modal">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">删除</h4>
                </div>
                <div class="modal-body">
                    <span id="delete_instance_content"></span>
                    <input type="hidden" id="delete_instance_name" name="delete_instance_name" value=""/>
                </div>
                <div class="modal-footer">
                    <button id="delete_instance_confirm" type="button" class="btn btn-success"> 确定 </button>
                    <button type="button" class="btn btn-default" data-dismiss="modal"> 关闭 </button>
                </div>
            </div>
        </div>
    </div>

    <!-- delay course dialog -->
    <div id="create_snapshot_confirm_dialog" class="modal">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">创建镜像</h4>
                </div>
                <div class="modal-body">
                    <form id="create_snapshot_form">
                        <div class="form-group name">
                            <label for="form-field-8">镜像名称</label>
                            <div class="">
                                <input class="form-control" type="text" id="snapshot_name" name="snapshot_name"
                                       placeholder="输入镜像名称"
                                       data-rule-required='true' data-msg-required='请填写镜像名称'
                                       data-rule-maxlength='64' data-msg-required='长度不能超过64个字符'
                                       data-rule-isname="true" data-msg-isname='只能使用英文字符,数字,下划线,横杠和点'>
                            </div>
                            <div class="" style="display:none">
                                <input class="form-control" type="text" id="create_snapshot_vmid" name="create_snapshot_vmid" value="">
                            </div>
                        </div>

                        <div class="form-group format">
                            <label for="form-field-8">镜像描述</label>
                            <div class="">
                                <textarea id="snapshot_description"
                                          name="snapshot_description"
                                          class="autosize-transition form-control" style="width:100%; height:100px; overflow: hidden; word-wrap: break-word; resize: vertical;"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button id="create_snapshot_button_confirm" type="button" class="btn btn-success"> 确定</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal"> 取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- power on vm confirmation dialog -->
    <div id="power_on_confirm_dialog" class="modal">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">开机</h4>
                </div>
                <div class="modal-body">
                    <span class="red"><i class="ace-icon fa fa-warning icon-animated-bell bigger-130"></i> 确定开机吗？</span>
                    <input type="hidden" id="power_on_data" name="power_on_data" value=""/>
                </div>
                <div class="modal-footer">
                    <button id="power_on_confirm" type="button" class="btn btn-success"> 确定 </button>
                    <button type="button" class="btn btn-default" data-dismiss="modal"> 关闭 </button>
                </div>
            </div>
        </div>
    </div>

    <!-- power off vm confirmation dialog -->
    <div id="power_off_confirm_dialog" class="modal">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">关机</h4>
                </div>
                <div class="modal-body">
                    <span class="red"><i class="ace-icon fa fa-warning icon-animated-bell bigger-130"></i> 确定关机吗？</span>
                    <input type="hidden" id="power_off_data" name="power_off_data" value=""/>
                </div>
                <div class="modal-footer">
                    <button id="power_off_confirm" type="button" class="btn btn-success"> 确定 </button>
                    <button type="button" class="btn btn-default" data-dismiss="modal"> 关闭 </button>
                </div>
            </div>
        </div>
    </div>

    <div id="fail_dialog" class="modal">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">操作结果</h4>
                </div>
                <div class="modal-body">
                    <p>
                        <span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>
                        <span id="fail_content">操作失败</span>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal"> 确定 </button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block inline_scripts %}
    {{ super() }}

    <script>
        active_sidebar("#images", "#image_generator");
        var instance_dialog_mode = 'create';
        var timeout_interval = 10000;
        var dInsTable;
        setInterval("instance_list_reload()", timeout_interval);

        $(document).ready(function() {
            //Init JQUERY's data table
                dInsTable = $('#table_instance_list').dataTable({
                "language": {
                    "url": "{{ url_for('static', filename='i18n/jquery.dataTables.json') }}"
                },
                "aoColumns": [
                    null, null, null, null,
                    {"bSortable": false, "bSearchable": false}
                ],
                "aaSorting": []
            });


            $("#generate_instance").click(function () {
                $("#launch_form").validate().resetForm(); //重置表单
                $("#launch_form label.error").remove(); //重置错误信息
                $('#launch_imageid').val('').trigger('chosen:updated');
                $('#image_flavor').val('').trigger('chosen:updated');
                $('#launch_imageid').select2('val',"");
                $('#image_flavor').select2('val',"");
                $('#network_ref').select2('val',"");
                $("#generate_dialog").modal("show");
            });

            var $validator = $("#launch_form").validate({
                ignore: ''
            });

            $("#image_flavor").change(function(){
                $validator.showErrors({image_flavor:""});
            });

            $("#launch_imageid").change(function(){
                $validator.showErrors({launch_imageid:""});
            });

            $("#network_ref").change(function(){
                $validator.showErrors({network_ref:""});
            });

            $("#confirm_generate").click(function() {
                var isvalid = $("#launch_form").valid();
                if(!isvalid){
                    return;
                }
                var options = {
                    beforeSubmit: beforeSubmit,
                    success: success_launch_callback,
                    url: "{{ url_for('teachers_image.launch_instance') }}",
                    type: "POST",
                    dataType: "json",
                    timeout: 120000
                };

                function beforeSubmit(formData, jqForm, options) {
                    var rt = true;

                    if (!$("#instance_name").valid()) {
                        $("#name_error").css("display", "block")
                        rt = false
                    }
                    else
                        $("#name_error").css("display", "none")

                    if (!jQuery("#launch_imageid  option:selected").text()) {
                        $("#image_id_error").css("display", "block");
                        rt = false
                    }
                    else
                        $("#image_id_error").css("display", "none")

                    if (!jQuery("#image_flavor  option:selected").text()) {
                        $("#flavor_error").css("display", "block")
                        rt = false
                    }
                    else
                        $("#flavor_error").css("display", "none")

                    if (!jQuery("#network_ref  option:selected").text()) {
                        $("#network_error").css("display", "block")
                        rt = false
                    }
                    else
                        $("#network_error").css("display", "none")


{#                    <!--if (rt) {-->#}
{#                        <!--$.blockUI({message: "<h1>正在创建镜像实例...</h1>"});-->#}
{#                    <!--}-->#}
                    return rt
                }

                $("#launch_form").ajaxSubmit(options);
                $("#generate_dialog").modal("hide");
            });

            $("#generate_dialog .select2").select2({
                language:"zh-CN",
                allowClear: true
            });

            $("#create_snapshot_button_confirm").click(function () {
                createSnapshot();
            });

            $("#power_on_confirm").click(function () {
                $("#power_on_confirm_dialog").modal("hide");
                var id = $("#power_on_data").val();
                power_on(id);
            });

            $("#power_off_confirm").click(function () {
                $("#power_off_confirm_dialog").modal("hide");
                var id = $("#power_off_data").val();
                power_off(id);
            });

            $("#delete_instance_confirm").click(function () {
                $("#delete_instance_confirm_dialog").modal("hide");
                deleteInstance();
            });

            $("#launch_imageid").change(function (evt, params) {
                $(this).valid();
                id = $("#launch_imageid").val();
                reset_options("#image_flavor");
                flavor_filter(id, "#image_flavor");
                $("#image_flavor").trigger("liszt:updated");
            });

            $("#image_flavor").change(function (evt, params) {
                $(this).valid();
            });

        });

        function success_launch_callback(responseText, responseStatus) {
            var response_result = eval(responseText)
            var content;
            if (response_result['status'] == "success") {
                location.reload();
                $.gritter.add({
                    // (string | mandatory) the text inside the notification
                    text: '创建成功',
                    class_name: 'gritter-success'
                });
            } else if (response_result['status'] == "existed") {
                content = "已存在同名实例，请重新命名";
                $.gritter.add({
                    // (string | mandatory) the text inside the notification
                    text: content,
                    class_name: 'gritter-error'
                });
            }
            else {
                content = "操作失败";
                $.gritter.add({
                    // (string | mandatory) the text inside the notification
                    text: content,
                    class_name: 'gritter-error'
                });
            }
            $.unblockUI();
        }

        function flavor_filter(vmid, selector) {
            if (!valid_vm_flavor(vmid))
                return false

            min_ram = eval($("#" + vmid + "_min_ram").html())
            min_disk = eval($("#" + vmid + "_min_disk").html())

            options = $(selector).children()
            for (i = 0; i < options.length; i++) {
                flavor = options[i].innerHTML
                if (flavor == "")
                    continue;
                flavor_ram = flavor.split('|')[1]
                flavor_ram = eval(flavor_ram.substr(0, flavor_ram.length -
                        2))

                flavor_disk = flavor.split('|')[2]
                flavor_disk = eval(flavor_disk.substr(0, flavor_disk.length
                        - 2))

                if (min_ram > flavor_ram || min_disk > flavor_disk)
                    // 这行代码用来隐藏不合要求的option
                    $(options[i]).wrap("<span style='display:none'></span>");
            }

        }

        function reset_options(selector) {
            // 恢复隐藏的option
            $(selector).children("span").each(function(){
                $(this).children().clone().replaceAll($(this));
            });
            // 清空select的选项
            $(selector).val('').select2('val',"");
        }

        function valid_vm_flavor(vmid) {
            min_ram = $("#" + vmid + "_min_ram").html()
            min_disk = $("#" + vmid + "_min_disk").html()
            if (min_disk != "" && min_ram != "")
                return true
        }

        function deleteInstanceDialog(id, name) {
            $("#delete_instance_content").html("确定要删除实例" + name + "吗？");
            $("#delete_instance_name").val(id+'|'+name); //设置删除image
            $("#delete_instance_confirm_dialog").modal("show");
        }

        function createSnapshotDialog(id) {
            $("#create_snapshot_confirm_dialog").resetForm();
            $("#create_snapshot_vmid").val(id);
            $("#create_snapshot_confirm_dialog").modal("show");
        }

        function launch_dialog(imageid) {
            $("#launch_imageid").val(imageid);
            reset_options("#add_pool_flavor");
            flavor_filter(imageid, "#add_pool_flavor");
            $("#add_pool_flavor").trigger("liszt:updated");
            $("#launch_dialog").dialog('open');
        }

        function power_on_dialog(vmid) {
            $("#power_on_data").val(vmid);
            $("#power_on_confirm_dialog").modal("show");
        }

        function power_off_dialog(vmid) {
            $("#power_off_data").val(vmid);
            $("#power_off_confirm_dialog").modal("show");
        }

        $('#generator_reset').click(function () {
            $("#launch_form").resetForm(); //重置表单
            $("#launch_form label.error").remove(); //重置错误信息
            $('#launch_imageid').val('').select2('val',"");
            $('#image_flavor').val('').select2('val',"");
            $('#network_ref').val('').select2('val',"");
        });

        function deleteInstance() {
            vmid = $("#delete_instance_name").val();
            $.ajax({
                url: "{{ url_for('teachers_image.delete_instance') }}",
                type: 'post',
                async: false,
                data: {
                    vmid: vmid
                },
                success: function (responeText, status) {
                    if (responeText['status'] == "success") {
                        row = dInsTable.fnGetPosition(document.getElementById("instance_description_" + responeText['vmname']))[0];
                        dInsTable.fnDeleteRow(row)
                        $.gritter.add({
                            // (string | mandatory) the text inside the notification
                            text: '删除成功',
                            class_name: 'gritter-success'
                        });
                    } else {
                        var content = "操作失败";
                        $.gritter.add({
                            // (string | mandatory) the text inside the notification
                            text: content,
                            class_name: 'gritter-error'
                        });
                    }
                }
            });
        }

        function createSnapshot() {
            var options = {
                beforeSubmit: beforeSubmit,
                success: callback,
                url: "{{ url_for('teachers_image.create_snapshot') }}",
                type: "post",
                dataType: "json"
            };

            function beforeSubmit(formData, jqForm, options) {
                if ($("#create_snapshot_form").validate()) {
                    $("#create_snapshot_confirm_dialog").modal("hide");
                    $.blockUI({message: "<h1>正在创建镜像...</h1>"})
                } else {
                    return false;
                }
            }

            function callback(responeText, statusText) {
                var content;
                if (responeText["status"] == "success") {
                    content = "创建镜像成功"
                    $("#create_snapshot_confirm_dialog").modal("hide");
                    $.gritter.add({
                        // (string | mandatory) the text inside the notification
                        text: content,
                        class_name: 'gritter-success'
                    });
                    location.href = "{{ url_for('teachers_image.image_list') }}";
                } else if (responeText["status"] == "exist") {
                    content = "创建失败，存在同名镜像";
                    $.gritter.add({
                        // (string | mandatory) the text inside the notification
                        text: content,
                        class_name: 'gritter-error'
                    });
                } else {
                    content = "创建镜像失败";
                    $.gritter.add({
                        // (string | mandatory) the text inside the notification
                        text: content,
                        class_name: 'gritter-error'
                    });
                }
                $.unblockUI();
            }
            $("#create_snapshot_form").ajaxSubmit(options);
        }

        function power_on(vmid) {
            $.ajax({
                url: "{{url_for('teachers_image.power_on')}}",
                type: 'post',
                async: false,
                data: {
                    vmid: vmid
                },
                success: function (responeText, status) {
                    if (responeText["status"] == 'success') {
                        instance_list_reload();
                        //location.reload();
                    } else {
                        var content = "操作失败";
                        $.gritter.add({
                            // (string | mandatory) the text inside the notification
                            text: content,
                            class_name: 'gritter-error'
                        });
                    }
                }
            });
        }

        function power_off(vmid) {
            $.ajax({
                url: "{{ url_for('teachers_image.power_off') }}",
                type: 'post',
                async: false,
                data: {
                    vmid: vmid
                },
                success: function (responeText, status) {
                    if (responeText['status'] == 'success') {
                        instance_list_reload();
                        //location.reload();
                    } else {
                        var content = "操作失败";
                        $.gritter.add({
                            // (string | mandatory) the text inside the notification
                            text: content,
                            class_name: 'gritter-error'
                        });
                    }
                }
            });
        }

        function instance_list_reload() {
            // var instance_ids = [];
            var instance_names = [];
            $("#table_instance_list tbody tr").each(function () {
                name_cell = $($(this).children()[0])
                if (name_cell.children()[0]) {
                    name_cell = $(name_cell.children()[0]);
                }
                name = name_cell.html();
                instance_names.push(name)
            });

            var options = {
                type: "post",
                success: callback,
                cache: false,
                data: {
                    names: instance_names
                },
                dataType: "json",
                url: "{{ url_for('teachers_image.image_instance_list') }}"
            };

            function callback(responseJson, statusText) {
                var instance_info = eval(responseJson)

                for (var i = 0; i < instance_info.length; i++) {

                    if (document.getElementById("instance_description_" + instance_info[i].fields.name) == null) {
                        continue;
                    }

                    // display console if status changed
                    if (document.getElementById("instance_status_" + instance_info[i].fields.name).innerText != "已启动"
                            && instance_info[i].fields.status == "ACTIVE") {
                        generate_vnc_console(instance_info[i].fields.console, instance_info[i].fields.vmid, instance_info[i].fields.name)
                    }

                    dInsTable.fnUpdate(
                            generateHTMLFromInstance(
                                    instance_info[i].fields.vmid,
                                    instance_info[i].fields.name,
                                    instance_info[i].fields.image,
                                    instance_info[i].fields.description,
                                    instance_info[i].fields.ip,
                                    instance_info[i].fields.status,
                                    instance_info[i].fields.console
                            ), dInsTable.fnGetPosition(document.getElementById("instance_description_" + instance_info[i].fields.name))[0], undefined, false
                    );
                }
            }

            $.ajax(options);
        }


        function generateHTMLFromInstance(vmid, name, image, description, ip, status, vnc_console) {
            status_text = "已关闭";
            if (status == "ACTIVE") {
                status_text = "已启动";
                vm_name_html = "<a href='#instance_block_header' onclick=\"generate_vnc_console('" + vnc_console + "','" + vmid + "','" + name + "')\">" + name + "</a>";
            } else {
                vm_name_html = name;
            }

            if (ip == null)
                ip = "未分配";

            if_active = ""
            if (status == "ACTIVE")
            {
                if_active == ""
            }
            else if (status == "STARTING" || status == "SPAWNING") {
                status_text = '<div class="progress progress-striped active"> \
                   <div class="progress-bar progress-bar-success" style="width: 100%;">启动中...</div> \
                   </div>';
                if_active = 'class="disableCss"';
            }
            else if (status == "STOPPING") {
                status_text = '<div class="progress progress-striped active"> \
                   <div class="progress-bar progress-bar-pink" style="width: 100%;">关闭中...</div> \
                   </div>';
                if_active = 'class="disableCss"';
            }
            else if (status == "DELETING") {
                status_text = '<div class="progress progress-striped active"> \
                   <div class="progress-bar progress-bar-danger" style="width: 100%;">删除中...</div> \
                   </div>';
                if_active = 'class="disableCss"';
            }
            else if (status == "SHUTOFF")
            {
                if_active = 'class="disableCss"';
            }
            else if (status == "ERROR") {
                status_text = "ERROR";
                if_active = 'class="disableCss"';
            }

            //if (status != "ACTIVE") {
            //    if_active = 'class="disableCss"';
            //}
            //else {
            //    if_active = "";
            //}

            //if (status != "SHUTOFF") {
            //    if_shutoff = "disabled";
            //}
            //else {
            //    if_shutoff = "";
            //}

            btn_text = "<div class='action-buttons'><a href='javascript:void(0)' id='btn_snap_" + vmid + "' title='生成镜像' " + if_active +
                    " onclick=\"createSnapshotDialog('" + vmid + "')\"><i class='ace-icon fa fa-check-circle-o bigger-130'></i></a>";

            if (status == 'ACTIVE')
            {
                btn_text = btn_text + "<a href='javascript:void(0)'  id='btn_snap_" + vmid+ "'  title='关机' " + " onclick=\"power_off_dialog('" + vmid + "')\"><i class='ace-icon fa fa-power-off bigger-130'></i></a>";
            }
            else if (status == "SHUTOFF")
            {
               btn_text = btn_text + "<a href='javascript:void(0)'  id='btn_inspower_" + vmid + "'  title='开机' " +" onclick=\"power_on_dialog('" + vmid + "')\"><i class='ace-icon fa fa-play-circle bigger-130'></i></a>";
            }
            else
            {
                btn_text = btn_text + "<a href='javascript:void(0)' class='disableCss' id='btn_snap_" + vmid + "'  title=\"关机\" onclick=\"power_off_dialog('" + vmid + "')\"><i class='ace-icon fa fa-power-off bigger-130'></i></a>";
            }
            <!--else-->
            <!--{-->
                <!--if (status != 'SHUTOFF') {-->
{#                    <!--btn_text = btn_text + "<a href='#'  id='btn_snap_" + vmid+ "'  title='关机' " + if_active +" onclick=\"power_off_dialog('" + vmid + "')\"><i class='ace-icon fa fa-power-off bigger-130'></i></a>";-->#}
                <!--} else {-->
{#                    <!--btn_text = btn_text + "<a href='#'  id='btn_inspower_" + vmid + "'  title='开机' " + if_active +" onclick=\"power_on_dialog('" + vmid + "')\"><i class='ace-icon fa fa-play-circle bigger-130'></i></a>";-->#}
                <!--}-->

            <!--}-->


            btn_text = btn_text +
                "<a href='javascript:void(0)' class='red' title=\"删除\" onclick=\"deleteInstanceDialog('" + vmid + "', '" + name + "')\"><i class='ace-icon fa fa-trash-o bigger-130'></i></a></div>";


            return [vm_name_html, image, "<span>" + description + "</span>", ip, status_text, btn_text]
        }

        function generate_vnc_console(src, vmid, name) {
            var iframe = $("<iframe></iframe>")
            iframe.addClass("vinzor_canvas_body").attr('src', src)
            $("#console_embed").html("")
            $("#console_embed").append(iframe)
            $("#instance_header").html('[' + vmid + ']' + ' - ' + '[' + name + ']')
        }

    </script>
{% endblock %}
